<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主题同步修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>主题同步修复测试</h1>
        <p>测试修复后的主题颜色云端同步功能</p>

        <div class="test-section">
            <h3>1. 初始化测试环境</h3>
            <button onclick="initTestEnvironment()">初始化测试环境</button>
            <button onclick="clearAllData()">清空所有数据</button>
        </div>

        <div class="test-section">
            <h3>2. Supabase连接测试</h3>
            <button onclick="testSupabaseConnection()">测试Supabase连接</button>
            <button onclick="enableCloudSync()">启用云端同步</button>
            <button onclick="disableCloudSync()">禁用云端同步</button>
        </div>

        <div class="test-section">
            <h3>3. 主题保存测试</h3>
            <button onclick="setTheme('dark')">设置暗黑主题</button>
            <button onclick="setTheme('blue')">设置蓝色主题</button>
            <button onclick="setTheme('green')">设置绿色主题</button>
            <button onclick="setTheme('purple')">设置紫色主题</button>
        </div>

        <div class="test-section">
            <h3>4. 数据验证测试</h3>
            <button onclick="loadLocalData()">加载本地数据</button>
            <button onclick="loadCloudData()">加载云端数据</button>
            <button onclick="compareData()">对比本地和云端数据</button>
        </div>

        <div class="test-section">
            <h3>5. 同步状态检查</h3>
            <button onclick="checkSyncStatus()">检查同步状态</button>
            <button onclick="manualSync()">手动同步</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="lib/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 清空日志
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 初始化测试环境
        async function initTestEnvironment() {
            try {
                log('正在初始化测试环境...', 'info');
                
                // 初始化同步管理器
                await syncManager.init();
                log('同步管理器初始化完成', 'success');
                
                // 初始化配置管理器
                if (typeof themeConfigManager !== 'undefined') {
                    await themeConfigManager.init();
                    log('配置管理器初始化完成', 'success');
                }
                
                log('测试环境初始化完成', 'success');
            } catch (error) {
                log(`初始化失败: ${error.message}`, 'error');
            }
        }

        // 清空所有数据
        async function clearAllData() {
            try {
                log('正在清空所有数据...', 'warning');
                
                // 清空Chrome Storage
                if (chrome && chrome.storage && chrome.storage.sync) {
                    await chrome.storage.sync.clear();
                } else {
                    localStorage.clear();
                }
                
                log('本地数据已清空', 'success');
                
                // 如果有云端连接，也清空云端数据
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    await syncManager.saveData({ categories: [], settings: {}, themeSettings: null });
                    log('云端数据已清空', 'success');
                }
                
                log('所有数据清空完成', 'success');
            } catch (error) {
                log(`清空数据失败: ${error.message}`, 'error');
            }
        }

        // 测试Supabase连接
        async function testSupabaseConnection() {
            try {
                log('正在测试Supabase连接...', 'info');
                
                const status = supabaseClient.getConnectionStatus();
                log(`连接状态: ${JSON.stringify(status)}`, 'info');
                
                if (status.isConnected) {
                    log('Supabase连接正常', 'success');
                } else {
                    log('Supabase未连接', 'warning');
                }
            } catch (error) {
                log(`连接测试失败: ${error.message}`, 'error');
            }
        }

        // 启用云端同步
        async function enableCloudSync() {
            try {
                log('正在启用云端同步...', 'info');
                
                // 使用测试配置
                const testConfig = {
                    url: 'https://your-project.supabase.co',
                    anonKey: 'your-anon-key',
                    userId: 'test-user-123',
                    enabled: true
                };
                
                await syncManager.enableSupabaseSync(testConfig);
                log('云端同步已启用', 'success');
                
                // 检查状态
                const status = syncManager.getSyncStatus();
                log(`同步状态: ${JSON.stringify(status)}`, 'info');
            } catch (error) {
                log(`启用云端同步失败: ${error.message}`, 'error');
            }
        }

        // 禁用云端同步
        async function disableCloudSync() {
            try {
                log('正在禁用云端同步...', 'info');
                
                await syncManager.disableSupabaseSync();
                log('云端同步已禁用', 'success');
                
                // 检查状态
                const status = syncManager.getSyncStatus();
                log(`同步状态: ${JSON.stringify(status)}`, 'info');
            } catch (error) {
                log(`禁用云端同步失败: ${error.message}`, 'error');
            }
        }

        // 设置主题（模拟主题切换）
        async function setTheme(theme) {
            try {
                log(`正在设置主题为: ${theme}`, 'info');
                
                // 模拟主题设置逻辑
                const themeSettings = {
                    theme: theme,
                    backgroundImageUrl: null,
                    backgroundImagePath: null,
                    backgroundOpacity: 30,
                    lastModified: new Date().toISOString()
                };
                
                // 检查是否应该保存到云端
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    log('检测到云端同步已启用，保存到云端...', 'info');
                    
                    // 获取当前数据
                    const currentData = await syncManager.loadData(true) || { categories: [], settings: {} };
                    
                    // 更新主题设置
                    currentData.themeSettings = themeSettings;
                    
                    // 保存到云端
                    await syncManager.saveData(currentData);
                    log(`主题 ${theme} 已保存到云端`, 'success');
                } else {
                    log('云端同步未启用，保存到本地...', 'info');
                    
                    // 保存到本地
                    if (chrome && chrome.storage && chrome.storage.sync) {
                        await chrome.storage.sync.set({ quickNavTheme: theme });
                    } else {
                        localStorage.setItem('quickNavTheme', theme);
                    }
                    log(`主题 ${theme} 已保存到本地`, 'success');
                }
                
                log(`主题设置完成: ${theme}`, 'success');
            } catch (error) {
                log(`设置主题失败: ${error.message}`, 'error');
            }
        }

        // 加载本地数据
        async function loadLocalData() {
            try {
                log('正在加载本地数据...', 'info');
                
                let localData;
                if (chrome && chrome.storage && chrome.storage.sync) {
                    localData = await new Promise(resolve => {
                        chrome.storage.sync.get(null, resolve);
                    });
                } else {
                    localData = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        try {
                            localData[key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            localData[key] = localStorage.getItem(key);
                        }
                    }
                }
                
                log(`本地数据: ${JSON.stringify(localData, null, 2)}`, 'info');
            } catch (error) {
                log(`加载本地数据失败: ${error.message}`, 'error');
            }
        }

        // 加载云端数据
        async function loadCloudData() {
            try {
                log('正在加载云端数据...', 'info');
                
                if (!window.syncManager || !syncManager.isSupabaseEnabled) {
                    log('云端同步未启用', 'warning');
                    return;
                }
                
                const cloudData = await syncManager.loadFromSupabase();
                log(`云端数据: ${JSON.stringify(cloudData, null, 2)}`, 'info');
            } catch (error) {
                log(`加载云端数据失败: ${error.message}`, 'error');
            }
        }

        // 对比本地和云端数据
        async function compareData() {
            try {
                log('正在对比本地和云端数据...', 'info');
                
                // 加载本地数据
                const localData = await syncManager.loadFromChromeStorage();
                
                // 加载云端数据
                let cloudData = null;
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    cloudData = await syncManager.loadFromSupabase();
                }
                
                log('=== 数据对比结果 ===', 'info');
                log(`本地数据: ${JSON.stringify(localData, null, 2)}`, 'info');
                log(`云端数据: ${JSON.stringify(cloudData, null, 2)}`, 'info');
                
                // 对比主题设置
                const localTheme = localData?.themeSettings?.theme;
                const cloudTheme = cloudData?.themeSettings?.theme;
                
                if (localTheme === cloudTheme) {
                    log(`主题设置一致: ${localTheme}`, 'success');
                } else {
                    log(`主题设置不一致 - 本地: ${localTheme}, 云端: ${cloudTheme}`, 'error');
                }
            } catch (error) {
                log(`数据对比失败: ${error.message}`, 'error');
            }
        }

        // 检查同步状态
        function checkSyncStatus() {
            try {
                log('正在检查同步状态...', 'info');
                
                const status = syncManager.getSyncStatus();
                log(`同步状态详情:`, 'info');
                log(`- 存储模式: ${status.storageMode}`, 'info');
                log(`- Supabase启用: ${status.isSupabaseEnabled}`, 'info');
                log(`- 最后同步时间: ${status.lastSyncTime || '从未同步'}`, 'info');
                log(`- 同步进行中: ${status.syncInProgress}`, 'info');
                log(`- Supabase状态: ${JSON.stringify(status.supabaseStatus)}`, 'info');
            } catch (error) {
                log(`检查同步状态失败: ${error.message}`, 'error');
            }
        }

        // 手动同步
        async function manualSync() {
            try {
                log('正在执行手动同步...', 'info');
                
                if (!window.syncManager || !syncManager.isSupabaseEnabled) {
                    log('云端同步未启用，无法执行手动同步', 'warning');
                    return;
                }
                
                const result = await syncManager.manualSync();
                log('手动同步完成', 'success');
                log(`同步结果: ${JSON.stringify(result, null, 2)}`, 'info');
            } catch (error) {
                log(`手动同步失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后自动初始化
        window.addEventListener('load', () => {
            log('页面加载完成，准备开始测试', 'info');
            log('请先点击"初始化测试环境"按钮', 'info');
        });
    </script>
</body>
</html>
