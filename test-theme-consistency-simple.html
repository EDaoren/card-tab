<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¢˜ä¸€è‡´æ€§ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #3367d6;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ ä¸»é¢˜ä¸€è‡´æ€§ç®€å•æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„ä¸»é¢˜è®¾ç½®æ•°æ®ä¸€è‡´æ€§</p>

        <div class="test-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div id="status-display">
                <p>å½“å‰ä¸»é¢˜: <span id="current-theme" class="status">æœªçŸ¥</span></p>
                <p>èƒŒæ™¯é€æ˜åº¦: <span id="current-opacity">æœªçŸ¥</span></p>
                <p>äº‘ç«¯åŒæ­¥: <span id="sync-status" class="status">æœªçŸ¥</span></p>
            </div>
            <button class="button" onclick="checkStatus()">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ ¸å¿ƒæµ‹è¯•</h3>
            <div>
                <button class="button" onclick="runBasicTest()">ğŸš€ è¿è¡ŒåŸºç¡€æµ‹è¯•</button>
                <button class="button" onclick="runConsistencyTest()">ğŸ”„ è¿è¡Œä¸€è‡´æ€§æµ‹è¯•</button>
                <button class="button" onclick="runMigrationTest()">ğŸ“¦ è¿è¡Œè¿ç§»æµ‹è¯•</button>
                <button class="button" onclick="runFixValidationTest()">ğŸ”§ ä¿®å¤éªŒè¯æµ‹è¯•</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="button" onclick="debugCurrentState()" style="background: #6c757d;">ğŸ” è°ƒè¯•çŠ¶æ€</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-log" class="log"></div>
            <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/utils.js"></script>
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            if (type === 'success') logEntry.style.color = '#155724';
            else if (type === 'error') logEntry.style.color = '#721c24';
            else if (type === 'warning') logEntry.style.color = '#856404';
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // æ£€æŸ¥çŠ¶æ€
        async function checkStatus() {
            try {
                log('ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€...', 'info');
                
                const currentTheme = window.currentTheme || 'unknown';
                const currentOpacity = window.currentBgOpacity || 'unknown';
                const syncEnabled = window.syncManager && syncManager.isSupabaseEnabled;
                
                document.getElementById('current-theme').textContent = currentTheme;
                document.getElementById('current-opacity').textContent = currentOpacity + '%';
                document.getElementById('sync-status').textContent = syncEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                document.getElementById('sync-status').className = `status ${syncEnabled ? 'success' : 'warning'}`;
                
                log(`âœ… çŠ¶æ€æ£€æŸ¥å®Œæˆ - ä¸»é¢˜: ${currentTheme}, é€æ˜åº¦: ${currentOpacity}%, åŒæ­¥: ${syncEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
            } catch (error) {
                log(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŸºç¡€æµ‹è¯•
        async function runBasicTest() {
            try {
                log('ğŸš€ å¼€å§‹åŸºç¡€æµ‹è¯•...', 'info');
                
                // æµ‹è¯•1: ä¿å­˜ä¸»é¢˜
                log('ğŸ“ æµ‹è¯•1: ä¿å­˜ä¸»é¢˜è®¾ç½®', 'info');
                if (typeof applyThemeForTesting === 'function') {
                    await applyThemeForTesting('blue', true);
                    log('âœ… è“è‰²ä¸»é¢˜ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    log('âš ï¸ ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆä¿å­˜ä¸»é¢˜', 'warning');
                    await applyTheme('blue', true);
                }
                
                // æµ‹è¯•2: åŠ è½½ä¸»é¢˜
                log('ğŸ“– æµ‹è¯•2: åŠ è½½ä¸»é¢˜è®¾ç½®', 'info');
                if (typeof loadThemeSettingsForTesting === 'function') {
                    await loadThemeSettingsForTesting();
                    log('âœ… ä¸»é¢˜è®¾ç½®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    log('âš ï¸ ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆåŠ è½½ä¸»é¢˜', 'warning');
                    await loadThemeSettings();
                }
                
                // éªŒè¯ç»“æœ
                const loadedTheme = window.currentTheme;
                if (loadedTheme === 'blue') {
                    log('âœ… åŸºç¡€æµ‹è¯•é€šè¿‡ï¼šä¸»é¢˜ä¿å­˜å’ŒåŠ è½½ä¸€è‡´', 'success');
                } else {
                    log(`âŒ åŸºç¡€æµ‹è¯•å¤±è´¥ï¼šæœŸæœ› blueï¼Œå®é™… ${loadedTheme}`, 'error');
                }
                
                await checkStatus();
                
            } catch (error) {
                log(`âŒ åŸºç¡€æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¸€è‡´æ€§æµ‹è¯•
        async function runConsistencyTest() {
            try {
                log('ğŸ”„ å¼€å§‹ä¸€è‡´æ€§æµ‹è¯•...', 'info');
                
                // ä¿å­˜æµ‹è¯•æ•°æ®
                const testTheme = 'green';
                const testOpacity = 60;
                
                log(`ğŸ“ ä¿å­˜æµ‹è¯•æ•°æ®: ä¸»é¢˜=${testTheme}, é€æ˜åº¦=${testOpacity}%`, 'info');

                // ä½¿ç”¨applyThemeForTestingæ¥æ­£ç¡®è®¾ç½®ä¸»é¢˜
                if (typeof applyThemeForTesting === 'function') {
                    await applyThemeForTesting(testTheme, false); // å…ˆè®¾ç½®ä¸»é¢˜ï¼Œä¸ä¿å­˜
                    log('âœ… ä¸»é¢˜è®¾ç½®æˆåŠŸ', 'success');
                } else {
                    log('âš ï¸ ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆè®¾ç½®ä¸»é¢˜', 'warning');
                    // ç›´æ¥æ›´æ–°å˜é‡ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
                    window.currentTheme = testTheme;
                }

                // æ›´æ–°é€æ˜åº¦ï¼ˆéœ€è¦ç›´æ¥æ›´æ–°ï¼Œå› ä¸ºæ²¡æœ‰ä¸“é—¨çš„å‡½æ•°ï¼‰
                window.currentBgOpacity = testOpacity;

                // ä¿å­˜åˆ°å­˜å‚¨
                if (typeof saveThemeSettingsUnified === 'function') {
                    await saveThemeSettingsUnified();
                    log('âœ… ç»Ÿä¸€ä¿å­˜å‡½æ•°æ‰§è¡ŒæˆåŠŸ', 'success');
                } else {
                    log('âŒ ç»Ÿä¸€ä¿å­˜å‡½æ•°ä¸å¯ç”¨', 'error');
                    return;
                }
                
                // ç­‰å¾…ä¿å­˜å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // ä»ä¸åŒæºåŠ è½½æ•°æ®è¿›è¡Œæ¯”è¾ƒ
                let chromeData = null;
                let supabaseData = null;
                let syncManagerData = null;
                
                if (window.syncManager) {
                    try {
                        chromeData = await syncManager.loadFromChromeStorage();
                        log(`ğŸ“± Chrome Storage: ${chromeData?.themeSettings?.theme || 'æ— '}`, 'info');
                    } catch (e) {
                        log(`âš ï¸ Chrome Storageè¯»å–å¤±è´¥: ${e.message}`, 'warning');
                    }
                    
                    if (syncManager.isSupabaseEnabled) {
                        try {
                            supabaseData = await syncManager.loadFromSupabase();
                            log(`â˜ï¸ Supabase: ${supabaseData?.themeSettings?.theme || 'æ— '}`, 'info');
                        } catch (e) {
                            log(`âš ï¸ Supabaseè¯»å–å¤±è´¥: ${e.message}`, 'warning');
                        }
                    }
                    
                    try {
                        syncManagerData = await syncManager.loadData(false);
                        log(`ğŸ”„ SyncManager: ${syncManagerData?.themeSettings?.theme || 'æ— '}`, 'info');
                    } catch (e) {
                        log(`âš ï¸ SyncManagerè¯»å–å¤±è´¥: ${e.message}`, 'warning');
                    }
                }
                
                // æ£€æŸ¥ä¸€è‡´æ€§
                const themes = [
                    chromeData?.themeSettings?.theme,
                    supabaseData?.themeSettings?.theme,
                    syncManagerData?.themeSettings?.theme
                ].filter(t => t);
                
                const isConsistent = themes.length === 0 || themes.every(t => t === themes[0]);
                
                if (isConsistent && themes.includes(testTheme)) {
                    log('âœ… ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡ï¼šæ‰€æœ‰å­˜å‚¨æºæ•°æ®ä¸€è‡´', 'success');
                } else {
                    log(`âŒ ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥ï¼šæ•°æ®ä¸ä¸€è‡´ [${themes.join(', ')}]`, 'error');
                }
                
            } catch (error) {
                log(`âŒ ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿ç§»æµ‹è¯•
        async function runMigrationTest() {
            try {
                log('ğŸ“¦ å¼€å§‹è¿ç§»æµ‹è¯•...', 'info');
                
                // åˆ›å»ºä¼ ç»Ÿæ ¼å¼æ•°æ®
                const legacyTheme = 'purple';
                const legacyOpacity = 45;
                
                log(`ğŸ“ åˆ›å»ºä¼ ç»Ÿæ ¼å¼æ•°æ®: ${legacyTheme}, ${legacyOpacity}%`, 'info');
                
                if (window.storage) {
                    await storage.set({
                        'quick_nav_theme': legacyTheme,
                        'quick_nav_bg_opacity': legacyOpacity
                    });
                    log('âœ… ä¼ ç»Ÿæ•°æ®å·²ä¿å­˜', 'success');
                    
                    // è§¦å‘è¿ç§»
                    if (typeof loadThemeSettingsForTesting === 'function') {
                        await loadThemeSettingsForTesting();
                    } else {
                        await loadThemeSettings();
                    }
                    
                    // æ£€æŸ¥è¿ç§»ç»“æœ
                    const migratedTheme = window.currentTheme;
                    const migratedOpacity = window.currentBgOpacity;
                    
                    if (migratedTheme === legacyTheme && migratedOpacity === legacyOpacity) {
                        log('âœ… è¿ç§»æµ‹è¯•é€šè¿‡ï¼šä¼ ç»Ÿæ•°æ®æˆåŠŸè¿ç§»', 'success');
                    } else {
                        log(`âŒ è¿ç§»æµ‹è¯•å¤±è´¥ï¼šæœŸæœ› ${legacyTheme}/${legacyOpacity}%, å®é™… ${migratedTheme}/${migratedOpacity}%`, 'error');
                    }
                } else {
                    log('âŒ storageå¯¹è±¡ä¸å¯ç”¨', 'error');
                }
                
            } catch (error) {
                log(`âŒ è¿ç§»æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                log('ğŸš€ åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...', 'info');
                
                // åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨
                await storageManager.init();
                log('âœ… StorageManager åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // åˆå§‹åŒ–ä¸»é¢˜è®¾ç½®
                if (typeof initThemeSettings === 'function') {
                    await initThemeSettings();
                    log('âœ… ä¸»é¢˜è®¾ç½®åˆå§‹åŒ–å®Œæˆ', 'success');
                }
                
                await checkStatus();
                log('ğŸ‰ æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºå½“å‰æ‰€æœ‰ç›¸å…³å˜é‡
        function debugCurrentState() {
            log('ğŸ” è°ƒè¯•ï¼šå½“å‰çŠ¶æ€è¯¦æƒ…', 'info');
            log(`  window.currentTheme: ${window.currentTheme}`, 'info');
            log(`  window.currentBgOpacity: ${window.currentBgOpacity}`, 'info');
            log(`  window.currentBgImageUrl: ${window.currentBgImageUrl}`, 'info');
            log(`  window.currentBgImagePath: ${window.currentBgImagePath}`, 'info');

            // å¦‚æœå¯ä»¥è®¿é—®æ¨¡å—å†…éƒ¨å˜é‡ï¼Œä¹Ÿæ˜¾ç¤ºå®ƒä»¬
            if (typeof getCurrentThemeState === 'function') {
                const moduleState = getCurrentThemeState();
                log(`  æ¨¡å—å†…éƒ¨çŠ¶æ€: ${JSON.stringify(moduleState)}`, 'info');
            }
        }

        // éªŒè¯ä¿®å¤çš„ä¸“é—¨æµ‹è¯•
        async function runFixValidationTest() {
            try {
                log('ğŸ”§ å¼€å§‹ä¿®å¤éªŒè¯æµ‹è¯•...', 'info');

                // æµ‹è¯•1: éªŒè¯å˜é‡åŒæ­¥
                log('ğŸ“ æµ‹è¯•1: éªŒè¯å˜é‡åŒæ­¥æœºåˆ¶', 'info');

                const testTheme = 'purple';
                const testOpacity = 75;

                // ç›´æ¥è®¾ç½®windowå˜é‡
                window.currentTheme = testTheme;
                window.currentBgOpacity = testOpacity;

                log(`è®¾ç½®windowå˜é‡: ${testTheme}, ${testOpacity}%`, 'info');

                // è°ƒç”¨ä¿å­˜å‡½æ•°
                if (typeof saveThemeSettingsUnified === 'function') {
                    await saveThemeSettingsUnified();
                    log('âœ… ä¿å­˜å‡½æ•°æ‰§è¡ŒæˆåŠŸ', 'success');
                } else {
                    log('âŒ ä¿å­˜å‡½æ•°ä¸å¯ç”¨', 'error');
                    return;
                }

                // ç­‰å¾…ä¿å­˜å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 500));

                // é‡æ–°åŠ è½½å¹¶éªŒè¯
                if (typeof loadThemeSettingsForTesting === 'function') {
                    await loadThemeSettingsForTesting();
                } else {
                    await loadThemeSettings();
                }

                const loadedTheme = window.currentTheme;
                const loadedOpacity = window.currentBgOpacity;

                if (loadedTheme === testTheme && loadedOpacity === testOpacity) {
                    log('âœ… ä¿®å¤éªŒè¯æµ‹è¯•é€šè¿‡ï¼šå˜é‡åŒæ­¥æ­£å¸¸', 'success');
                } else {
                    log(`âŒ ä¿®å¤éªŒè¯æµ‹è¯•å¤±è´¥ï¼šæœŸæœ› ${testTheme}/${testOpacity}%, å®é™… ${loadedTheme}/${loadedOpacity}%`, 'error');
                }

                debugCurrentState();

            } catch (error) {
                log(`âŒ ä¿®å¤éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
