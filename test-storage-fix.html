<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存储修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>存储修复测试</h1>
        <p>测试修复后的存储逻辑，确保主题设置不会被覆盖</p>

        <h3>测试步骤</h3>
        <button onclick="step1()">1. 初始化并启用云端同步</button>
        <button onclick="step2()">2. 保存主题设置</button>
        <button onclick="step3()">3. 模拟添加快捷方式</button>
        <button onclick="step4()">4. 检查主题设置是否保留</button>
        <button onclick="clearLog()">清空日志</button>

        <div class="log" id="log"></div>
    </div>

    <!-- 加载真实的脚本 -->
    <script src="lib/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 测试步骤
        async function step1() {
            log('=== 步骤1: 初始化并启用云端同步 ===', 'info');
            
            try {
                // 初始化syncManager
                await syncManager.init();
                log('✅ syncManager初始化完成', 'success');
                
                // 初始化storageManager
                await storageManager.init();
                log('✅ storageManager初始化完成', 'success');
                
                // 模拟启用云端同步
                syncManager.isSupabaseEnabled = true;
                syncManager.storageMode = 'hybrid';
                log('✅ 云端同步已启用', 'success');
                
                // 检查初始数据
                const initialData = await syncManager.loadData();
                log(`初始数据字段: ${Object.keys(initialData || {}).join(', ')}`, 'info');
                
            } catch (error) {
                log(`步骤1失败: ${error.message}`, 'error');
            }
        }

        async function step2() {
            log('=== 步骤2: 保存主题设置 ===', 'info');
            
            try {
                // 模拟保存主题设置
                if (typeof applyTheme === 'function') {
                    await applyTheme('dark', true);
                    log('✅ 主题设置已保存', 'success');
                } else {
                    // 手动保存主题设置
                    const currentData = await syncManager.loadData(true) || { categories: [], settings: {} };
                    currentData.themeSettings = {
                        theme: 'dark',
                        backgroundImageUrl: null,
                        backgroundImagePath: null,
                        backgroundOpacity: 30,
                        lastModified: new Date().toISOString()
                    };
                    
                    await syncManager.saveData(currentData);
                    log('✅ 手动保存主题设置完成', 'success');
                }
                
                // 验证主题设置
                const dataAfterTheme = await syncManager.loadData(true);
                if (dataAfterTheme && dataAfterTheme.themeSettings) {
                    log(`✅ 主题设置验证成功: ${dataAfterTheme.themeSettings.theme}`, 'success');
                } else {
                    log('❌ 主题设置验证失败', 'error');
                }
                
            } catch (error) {
                log(`步骤2失败: ${error.message}`, 'error');
            }
        }

        async function step3() {
            log('=== 步骤3: 模拟添加快捷方式 ===', 'info');
            
            try {
                // 检查保存前的数据
                const beforeData = await syncManager.loadData(true);
                log(`保存前数据字段: ${Object.keys(beforeData || {}).join(', ')}`, 'info');
                if (beforeData && beforeData.themeSettings) {
                    log(`保存前主题: ${beforeData.themeSettings.theme}`, 'info');
                }
                
                // 模拟添加快捷方式（这会触发storageManager.saveToStorage）
                const testCategory = {
                    name: '测试分类',
                    color: '#ff0000'
                };
                
                await storageManager.addCategory(testCategory);
                log('✅ 测试分类已添加', 'success');
                
                // 检查保存后的数据
                const afterData = await syncManager.loadData(true);
                log(`保存后数据字段: ${Object.keys(afterData || {}).join(', ')}`, 'info');
                
                if (afterData && afterData.themeSettings) {
                    log(`✅ 保存后主题仍然存在: ${afterData.themeSettings.theme}`, 'success');
                } else {
                    log('❌ 保存后主题设置丢失！', 'error');
                }
                
            } catch (error) {
                log(`步骤3失败: ${error.message}`, 'error');
            }
        }

        async function step4() {
            log('=== 步骤4: 最终检查 ===', 'info');
            
            try {
                // 最终数据检查
                const finalData = await syncManager.loadData(true);
                
                log('最终数据结构:', 'info');
                log(JSON.stringify(finalData, null, 2), 'info');
                
                // 检查各个字段
                const fields = ['categories', 'settings', 'themeSettings'];
                fields.forEach(field => {
                    if (finalData && finalData[field]) {
                        log(`✅ ${field} 字段存在`, 'success');
                        if (field === 'themeSettings') {
                            log(`   主题: ${finalData[field].theme}`, 'info');
                        } else if (field === 'categories') {
                            log(`   分类数量: ${finalData[field].length}`, 'info');
                        }
                    } else {
                        log(`❌ ${field} 字段缺失`, 'error');
                    }
                });
                
                // 检查storageManager的内部状态
                log('StorageManager内部状态:', 'info');
                log(`  data字段: ${Object.keys(storageManager.data || {}).join(', ')}`, 'info');
                log(`  fullData字段: ${Object.keys(storageManager.fullData || {}).join(', ')}`, 'info');
                
            } catch (error) {
                log(`步骤4失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成
        window.addEventListener('load', () => {
            log('存储修复测试页面加载完成', 'info');
            log('请按顺序执行测试步骤', 'info');
        });
    </script>
</body>
</html>
