<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .step {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æœ€ç»ˆä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„å®Œæ•´æµç¨‹ï¼Œæ¨¡æ‹Ÿæ‚¨çš„æµ‹è¯•åœºæ™¯</p>

        <div class="step">æµ‹è¯•åœºæ™¯ï¼šå¯ç”¨äº‘ç«¯åŒæ­¥ â†’ ä¿å­˜ä¸»é¢˜ â†’ æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®ä¿å­˜</div>

        <h3>æµ‹è¯•æ­¥éª¤</h3>
        <button onclick="step1()">1. æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <button onclick="step2()">2. å¯ç”¨äº‘ç«¯åŒæ­¥</button>
        <button onclick="step3()">3. ä¿å­˜ä¸»é¢˜è®¾ç½®</button>
        <button onclick="step4()">4. æ¨¡æ‹Ÿé¡µé¢é‡æ–°åŠ è½½</button>
        <button onclick="step5()">5. æ£€æŸ¥æœ€ç»ˆç»“æœ</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>

        <div class="log" id="log"></div>
    </div>

    <!-- åŠ è½½çœŸå®çš„è„šæœ¬ -->
    <script src="lib/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // æ­¥éª¤1ï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function step1() {
            log('=== æ­¥éª¤1: æ¸…ç©ºæ‰€æœ‰æ•°æ® ===', 'info');
            
            try {
                // æ¸…ç©ºChrome Storage
                if (chrome && chrome.storage && chrome.storage.sync) {
                    await new Promise(resolve => chrome.storage.sync.clear(resolve));
                    log('âœ… Chrome Storageå·²æ¸…ç©º', 'success');
                } else {
                    localStorage.clear();
                    log('âœ… localStorageå·²æ¸…ç©º', 'success');
                }
                
                // æ¸…ç©ºæ¨¡æ‹Ÿçš„äº‘ç«¯æ•°æ®
                localStorage.removeItem('mockSupabaseData');
                log('âœ… æ¨¡æ‹Ÿäº‘ç«¯æ•°æ®å·²æ¸…ç©º', 'success');
                
                log('æ‰€æœ‰æ•°æ®æ¸…ç©ºå®Œæˆ', 'success');
            } catch (error) {
                log(`æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤2ï¼šå¯ç”¨äº‘ç«¯åŒæ­¥
        async function step2() {
            log('=== æ­¥éª¤2: å¯ç”¨äº‘ç«¯åŒæ­¥ ===', 'info');
            
            try {
                // åˆå§‹åŒ–syncManager
                if (window.syncManager) {
                    await syncManager.init();
                    log('âœ… syncManageråˆå§‹åŒ–å®Œæˆ', 'success');
                    
                    // å¯ç”¨äº‘ç«¯åŒæ­¥
                    syncManager.isSupabaseEnabled = true;
                    syncManager.storageMode = 'hybrid';
                    log('âœ… äº‘ç«¯åŒæ­¥å·²å¯ç”¨', 'success');
                } else {
                    log('âŒ syncManagerä¸å­˜åœ¨', 'error');
                    return;
                }
                
                log('äº‘ç«¯åŒæ­¥å¯ç”¨å®Œæˆ', 'success');
            } catch (error) {
                log(`å¯ç”¨äº‘ç«¯åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤3ï¼šä¿å­˜ä¸»é¢˜è®¾ç½®
        async function step3() {
            log('=== æ­¥éª¤3: ä¿å­˜ä¸»é¢˜è®¾ç½® ===', 'info');
            
            try {
                // æ£€æŸ¥applyThemeå‡½æ•°
                if (typeof applyTheme !== 'function') {
                    log('âŒ applyThemeå‡½æ•°ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                // ä¿å­˜ä¸»é¢˜
                log('ä¿å­˜æš—é»‘ä¸»é¢˜...', 'info');
                await applyTheme('dark', true);
                log('âœ… ä¸»é¢˜ä¿å­˜å®Œæˆ', 'success');
                
                // ç«‹å³æ£€æŸ¥ä¿å­˜ç»“æœ
                const cloudData = await syncManager.loadData(true);
                log('ä¿å­˜åçš„äº‘ç«¯æ•°æ®:', 'info');
                log(JSON.stringify(cloudData, null, 2), 'info');
                
                if (cloudData && cloudData.themeSettings) {
                    log(`âœ… ä¸»é¢˜è®¾ç½®å·²ä¿å­˜: ${cloudData.themeSettings.theme}`, 'success');
                } else {
                    log('âŒ ä¸»é¢˜è®¾ç½®ä¿å­˜å¤±è´¥', 'error');
                }
                
            } catch (error) {
                log(`ä¿å­˜ä¸»é¢˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤4ï¼šæ¨¡æ‹Ÿé¡µé¢é‡æ–°åŠ è½½
        async function step4() {
            log('=== æ­¥éª¤4: æ¨¡æ‹Ÿé¡µé¢é‡æ–°åŠ è½½ ===', 'info');
            
            try {
                log('æ¨¡æ‹ŸstorageManageré‡æ–°åˆå§‹åŒ–...', 'info');
                
                // é‡æ–°åˆå§‹åŒ–storageManagerï¼ˆè¿™ä¼šè§¦å‘å¯èƒ½çš„æ•°æ®è¦†ç›–é—®é¢˜ï¼‰
                await storageManager.init();
                log('âœ… storageManageré‡æ–°åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // æ£€æŸ¥åˆå§‹åŒ–åçš„æ•°æ®
                const dataAfterInit = await syncManager.loadData(true);
                log('åˆå§‹åŒ–åçš„äº‘ç«¯æ•°æ®:', 'info');
                log(JSON.stringify(dataAfterInit, null, 2), 'info');
                
                if (dataAfterInit && dataAfterInit.themeSettings) {
                    log(`âœ… ä¸»é¢˜è®¾ç½®ä»ç„¶å­˜åœ¨: ${dataAfterInit.themeSettings.theme}`, 'success');
                } else {
                    log('âŒ ä¸»é¢˜è®¾ç½®åœ¨é‡æ–°åˆå§‹åŒ–åä¸¢å¤±ï¼', 'error');
                }
                
            } catch (error) {
                log(`æ¨¡æ‹Ÿé‡æ–°åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤5ï¼šæ£€æŸ¥æœ€ç»ˆç»“æœ
        async function step5() {
            log('=== æ­¥éª¤5: æ£€æŸ¥æœ€ç»ˆç»“æœ ===', 'info');
            
            try {
                // æœ€ç»ˆæ•°æ®æ£€æŸ¥
                const finalData = await syncManager.loadData(true);
                
                log('=== æœ€ç»ˆæ•°æ®ç»“æ„ ===', 'info');
                log(JSON.stringify(finalData, null, 2), 'info');
                
                // æ£€æŸ¥å„ä¸ªå­—æ®µ
                const expectedFields = ['categories', 'settings', 'themeSettings'];
                let allFieldsPresent = true;
                
                expectedFields.forEach(field => {
                    if (finalData && finalData[field]) {
                        log(`âœ… ${field} å­—æ®µå­˜åœ¨`, 'success');
                        if (field === 'themeSettings') {
                            log(`   ä¸»é¢˜: ${finalData[field].theme}`, 'info');
                            log(`   é€æ˜åº¦: ${finalData[field].backgroundOpacity}%`, 'info');
                        } else if (field === 'categories') {
                            log(`   åˆ†ç±»æ•°é‡: ${finalData[field].length}`, 'info');
                        } else if (field === 'settings') {
                            log(`   è§†å›¾æ¨¡å¼: ${finalData[field].viewMode}`, 'info');
                        }
                    } else {
                        log(`âŒ ${field} å­—æ®µç¼ºå¤±`, 'error');
                        allFieldsPresent = false;
                    }
                });
                
                if (allFieldsPresent) {
                    log('ğŸ‰ æµ‹è¯•æˆåŠŸï¼æ‰€æœ‰æ•°æ®å­—æ®µéƒ½æ­£ç¡®ä¿å­˜', 'success');
                } else {
                    log('âŒ æµ‹è¯•å¤±è´¥ï¼éƒ¨åˆ†æ•°æ®å­—æ®µç¼ºå¤±', 'error');
                }
                
            } catch (error) {
                log(`æœ€ç»ˆæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('æœ€ç»ˆä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'info');
            log('è¿™ä¸ªæµ‹è¯•æ¨¡æ‹Ÿæ‚¨çš„å®Œæ•´æµ‹è¯•åœºæ™¯', 'info');
            log('è¯·æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤', 'info');
        });
    </script>
</body>
</html>
