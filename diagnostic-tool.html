<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœç´¢åŠŸèƒ½è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .diagnostic-section {
      background: white;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .diagnostic-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #4285f4;
      padding-bottom: 10px;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 8px 0;
      font-family: monospace;
    }
    .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .test-button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #3367d6;
    }
    .test-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ æœç´¢åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
  <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©æˆ‘ä»¬è¯Šæ–­æœç´¢åŠŸèƒ½çš„é—®é¢˜</p>

  <div class="diagnostic-section">
    <h3>1. JavaScriptæ–‡ä»¶åŠ è½½æ£€æŸ¥</h3>
    <div id="js-loading-check"></div>
    <button class="test-button" onclick="checkJSLoading()">æ£€æŸ¥JSæ–‡ä»¶åŠ è½½</button>
  </div>

  <div class="diagnostic-section">
    <h3>2. DOMå…ƒç´ æ£€æŸ¥</h3>
    <div id="dom-check"></div>
    <button class="test-button" onclick="checkDOMElements()">æ£€æŸ¥DOMå…ƒç´ </button>
  </div>

  <div class="diagnostic-section">
    <h3>3. ç®¡ç†å™¨å®ä¾‹æ£€æŸ¥</h3>
    <div id="manager-check"></div>
    <button class="test-button" onclick="checkManagers()">æ£€æŸ¥ç®¡ç†å™¨å®ä¾‹</button>
  </div>

  <div class="diagnostic-section">
    <h3>4. äº‹ä»¶ç›‘å¬å™¨æ£€æŸ¥</h3>
    <div id="event-check"></div>
    <button class="test-button" onclick="checkEventListeners()">æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨</button>
  </div>

  <div class="diagnostic-section">
    <h3>5. æ§åˆ¶å°é”™è¯¯æ—¥å¿—</h3>
    <div id="console-errors"></div>
    <button class="test-button" onclick="checkConsoleErrors()">æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</button>
  </div>

  <div class="diagnostic-section">
    <h3>6. æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•</h3>
    <div id="manual-test"></div>
    <button class="test-button" onclick="testSearchEngine()">æµ‹è¯•æœç´¢å¼•æ“ä¸‹æ‹‰æ¡†</button>
    <button class="test-button" onclick="testSearch()">æµ‹è¯•æœç´¢åŠŸèƒ½</button>
  </div>

  <!-- åŠ è½½åŸå§‹é¡¹ç›®çš„æ‰€æœ‰JavaScriptæ–‡ä»¶ -->
  <script src="js/supabase.min.js"></script>
  <script src="js/icons.js"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/sync-manager.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/sync-ui.js"></script>
  <script src="js/category.js"></script>
  <script src="js/shortcut.js"></script>
  <script src="js/search.js"></script>
  <script src="js/view.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/main.js"></script>

  <script>
    // é”™è¯¯æ”¶é›†
    const errors = [];
    const logs = [];

    // æ•è·æ‰€æœ‰é”™è¯¯
    window.addEventListener('error', (e) => {
      errors.push({
        type: 'JavaScript Error',
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        stack: e.error ? e.error.stack : 'No stack trace'
      });
    });

    window.addEventListener('unhandledrejection', (e) => {
      errors.push({
        type: 'Promise Rejection',
        message: e.reason.toString(),
        stack: e.reason.stack || 'No stack trace'
      });
    });

    // é‡å†™console.logæ¥æ•è·æ—¥å¿—
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = function(...args) {
      logs.push({ type: 'log', args: args });
      originalLog.apply(console, args);
    };

    console.error = function(...args) {
      logs.push({ type: 'error', args: args });
      originalError.apply(console, args);
    };

    console.warn = function(...args) {
      logs.push({ type: 'warn', args: args });
      originalWarn.apply(console, args);
    };

    function addStatus(containerId, message, type = 'info') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      container.appendChild(div);
    }

    function checkJSLoading() {
      const container = document.getElementById('js-loading-check');
      container.innerHTML = '';

      const jsFiles = [
        'supabase.min.js', 'icons.js', 'supabase-client.js', 'sync-manager.js',
        'storage.js', 'sync-ui.js', 'category.js', 'shortcut.js', 
        'search.js', 'view.js', 'theme.js', 'main.js'
      ];

      const globalObjects = [
        { name: 'supabase', obj: window.supabase },
        { name: 'StorageManager', obj: window.StorageManager },
        { name: 'SearchManager', obj: window.SearchManager },
        { name: 'CategoryManager', obj: window.CategoryManager },
        { name: 'ShortcutManager', obj: window.ShortcutManager },
        { name: 'ViewManager', obj: window.ViewManager }
      ];

      globalObjects.forEach(check => {
        if (check.obj) {
          addStatus('js-loading-check', `âœ… ${check.name} ç±»å·²åŠ è½½`, 'success');
        } else {
          addStatus('js-loading-check', `âŒ ${check.name} ç±»æœªæ‰¾åˆ°`, 'error');
        }
      });

      // æ£€æŸ¥å®ä¾‹
      const instances = [
        { name: 'storageManager', obj: window.storageManager },
        { name: 'searchManager', obj: window.searchManager },
        { name: 'categoryManager', obj: window.categoryManager },
        { name: 'shortcutManager', obj: window.shortcutManager },
        { name: 'viewManager', obj: window.viewManager }
      ];

      instances.forEach(check => {
        if (check.obj) {
          addStatus('js-loading-check', `âœ… ${check.name} å®ä¾‹å·²åˆ›å»º`, 'success');
        } else {
          addStatus('js-loading-check', `âŒ ${check.name} å®ä¾‹æœªæ‰¾åˆ°`, 'error');
        }
      });
    }

    function checkDOMElements() {
      const container = document.getElementById('dom-check');
      container.innerHTML = '';

      const elements = [
        'search-input',
        'search-engine-selector',
        'search-engine-icon',
        'search-engine-dropdown-menu',
        'categories-container'
      ];

      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          addStatus('dom-check', `âœ… #${id} å…ƒç´ å­˜åœ¨`, 'success');
        } else {
          addStatus('dom-check', `âŒ #${id} å…ƒç´ ä¸å­˜åœ¨`, 'error');
        }
      });

      // æ£€æŸ¥CSSç±»
      const classes = [
        '.search-box',
        '.search-dropdown',
        '.search-engine-option'
      ];

      classes.forEach(className => {
        const elements = document.querySelectorAll(className);
        if (elements.length > 0) {
          addStatus('dom-check', `âœ… ${className} æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `, 'success');
        } else {
          addStatus('dom-check', `âŒ ${className} æœªæ‰¾åˆ°å…ƒç´ `, 'error');
        }
      });
    }

    function checkManagers() {
      const container = document.getElementById('manager-check');
      container.innerHTML = '';

      try {
        if (window.searchManager) {
          addStatus('manager-check', 'âœ… searchManager å­˜åœ¨', 'success');
          
          // æ£€æŸ¥searchManagerçš„å±æ€§
          const props = ['searchInput', 'searchBox', 'searchEngineSelector'];
          props.forEach(prop => {
            if (window.searchManager[prop]) {
              addStatus('manager-check', `âœ… searchManager.${prop} å­˜åœ¨`, 'success');
            } else {
              addStatus('manager-check', `âŒ searchManager.${prop} ä¸å­˜åœ¨`, 'error');
            }
          });
        } else {
          addStatus('manager-check', 'âŒ searchManager ä¸å­˜åœ¨', 'error');
        }

        if (window.storageManager) {
          addStatus('manager-check', 'âœ… storageManager å­˜åœ¨', 'success');
          
          if (window.storageManager.data) {
            addStatus('manager-check', 'âœ… storageManager.data å­˜åœ¨', 'success');
            
            if (window.storageManager.data.categories) {
              const count = window.storageManager.data.categories.length;
              addStatus('manager-check', `âœ… æ‰¾åˆ° ${count} ä¸ªåˆ†ç±»`, 'success');
            } else {
              addStatus('manager-check', 'âŒ storageManager.data.categories ä¸å­˜åœ¨', 'error');
            }
          } else {
            addStatus('manager-check', 'âŒ storageManager.data ä¸å­˜åœ¨', 'error');
          }
        } else {
          addStatus('manager-check', 'âŒ storageManager ä¸å­˜åœ¨', 'error');
        }
      } catch (error) {
        addStatus('manager-check', `âŒ æ£€æŸ¥ç®¡ç†å™¨æ—¶å‡ºé”™: ${error.message}`, 'error');
      }
    }

    function checkEventListeners() {
      const container = document.getElementById('event-check');
      container.innerHTML = '';

      // æ£€æŸ¥æœç´¢å¼•æ“é€‰æ‹©å™¨çš„äº‹ä»¶ç›‘å¬å™¨
      const selector = document.querySelector('.search-engine-selector');
      if (selector) {
        addStatus('event-check', 'âœ… æœç´¢å¼•æ“é€‰æ‹©å™¨å…ƒç´ å­˜åœ¨', 'success');
        
        // å°è¯•è§¦å‘ç‚¹å‡»äº‹ä»¶
        try {
          const clickEvent = new Event('click', { bubbles: true });
          selector.dispatchEvent(clickEvent);
          addStatus('event-check', 'âœ… ç‚¹å‡»äº‹ä»¶å·²è§¦å‘', 'success');
        } catch (error) {
          addStatus('event-check', `âŒ è§¦å‘ç‚¹å‡»äº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
        }
      } else {
        addStatus('event-check', 'âŒ æœç´¢å¼•æ“é€‰æ‹©å™¨å…ƒç´ ä¸å­˜åœ¨', 'error');
      }

      // æ£€æŸ¥æœç´¢è¾“å…¥æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        addStatus('event-check', 'âœ… æœç´¢è¾“å…¥æ¡†å…ƒç´ å­˜åœ¨', 'success');
        
        try {
          const inputEvent = new Event('input', { bubbles: true });
          searchInput.value = 'æµ‹è¯•';
          searchInput.dispatchEvent(inputEvent);
          addStatus('event-check', 'âœ… è¾“å…¥äº‹ä»¶å·²è§¦å‘', 'success');
        } catch (error) {
          addStatus('event-check', `âŒ è§¦å‘è¾“å…¥äº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
        }
      } else {
        addStatus('event-check', 'âŒ æœç´¢è¾“å…¥æ¡†å…ƒç´ ä¸å­˜åœ¨', 'error');
      }
    }

    function checkConsoleErrors() {
      const container = document.getElementById('console-errors');
      container.innerHTML = '';

      if (errors.length === 0) {
        addStatus('console-errors', 'âœ… æ²¡æœ‰JavaScripté”™è¯¯', 'success');
      } else {
        addStatus('console-errors', `âŒ å‘ç° ${errors.length} ä¸ªé”™è¯¯:`, 'error');
        errors.forEach((error, index) => {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'status error';
          errorDiv.innerHTML = `
            <strong>é”™è¯¯ ${index + 1}: ${error.type}</strong><br>
            ${error.message}<br>
            ${error.filename ? `æ–‡ä»¶: ${error.filename}:${error.lineno}:${error.colno}` : ''}
            <pre>${error.stack}</pre>
          `;
          container.appendChild(errorDiv);
        });
      }

      // æ˜¾ç¤ºæ§åˆ¶å°æ—¥å¿—
      if (logs.length > 0) {
        addStatus('console-errors', `ğŸ“ æ§åˆ¶å°æ—¥å¿— (${logs.length} æ¡):`, 'info');
        const logDiv = document.createElement('pre');
        logDiv.textContent = logs.map(log => 
          `[${log.type}] ${log.args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
          ).join(' ')}`
        ).join('\n');
        container.appendChild(logDiv);
      }
    }

    function testSearchEngine() {
      const container = document.getElementById('manual-test');
      
      const selector = document.querySelector('.search-engine-selector');
      if (selector) {
        addStatus('manual-test', 'ğŸ”„ å°è¯•ç‚¹å‡»æœç´¢å¼•æ“é€‰æ‹©å™¨...', 'info');
        selector.click();
        
        setTimeout(() => {
          const isOpen = selector.classList.contains('open');
          if (isOpen) {
            addStatus('manual-test', 'âœ… æœç´¢å¼•æ“ä¸‹æ‹‰æ¡†å·²æ‰“å¼€', 'success');
          } else {
            addStatus('manual-test', 'âŒ æœç´¢å¼•æ“ä¸‹æ‹‰æ¡†æœªæ‰“å¼€', 'error');
          }
        }, 100);
      } else {
        addStatus('manual-test', 'âŒ æœç´¢å¼•æ“é€‰æ‹©å™¨ä¸å­˜åœ¨', 'error');
      }
    }

    function testSearch() {
      const container = document.getElementById('manual-test');
      
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        addStatus('manual-test', 'ğŸ”„ å°è¯•æœç´¢åŠŸèƒ½...', 'info');
        searchInput.value = 'çŸ¥ä¹';
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        
        setTimeout(() => {
          const dropdown = document.querySelector('.search-dropdown');
          if (dropdown && dropdown.style.display !== 'none') {
            addStatus('manual-test', 'âœ… æœç´¢ä¸‹æ‹‰æ¡†å·²æ˜¾ç¤º', 'success');
          } else {
            addStatus('manual-test', 'âŒ æœç´¢ä¸‹æ‹‰æ¡†æœªæ˜¾ç¤º', 'error');
          }
        }, 100);
      } else {
        addStatus('manual-test', 'âŒ æœç´¢è¾“å…¥æ¡†ä¸å­˜åœ¨', 'error');
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œä¸€äº›æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        checkJSLoading();
        checkConsoleErrors();
      }, 1000);
    });
  </script>
</body>
</html>
