<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>搜索功能修复测试</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="fonts/material-symbols-rounded.css">
  <style>
    body {
      padding: 50px;
      background: #f5f5f5;
    }
    .test-info {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-info h3 {
      margin-top: 0;
      color: #333;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body class="theme-default">
  <div class="test-info">
    <h3>🔧 搜索功能修复测试</h3>
    <p>测试搜索框输入和搜索引擎下拉框功能</p>
    <div id="test-status" class="status info">
      正在初始化...
    </div>
  </div>

  <div class="search-container">
    <div class="search-box">
      <div class="search-input-row">
        <div class="search-engine-selector">
          <img src="https://www.google.com/favicon.ico" alt="Google" class="search-engine-icon">
          <span class="search-engine-dropdown">
            <span class="material-symbols-rounded">expand_more</span>
          </span>
          <!-- 下拉菜单 -->
          <div class="search-engine-dropdown-menu">
            <div class="search-engine-option" data-engine="0">
              <img src="https://www.google.com/favicon.ico" alt="Google">
              <span>Google</span>
            </div>
            <div class="search-engine-option" data-engine="1">
              <img src="https://www.bing.com/favicon.ico" alt="Bing">
              <span>Bing</span>
            </div>
            <div class="search-engine-option" data-engine="2">
              <img src="https://www.baidu.com/favicon.ico" alt="Baidu">
              <span>百度</span>
            </div>
            <div class="search-engine-option" data-engine="3">
              <img src="https://duckduckgo.com/favicon.ico" alt="DuckDuckGo">
              <span>DuckDuckGo</span>
            </div>
          </div>
        </div>
        <div class="search-input-container">
          <input type="text" id="search-input" placeholder="输入'知乎'测试搜索...">
        </div>
        <button class="search-button" type="button">
          <span class="material-symbols-rounded">search</span>
        </button>
      </div>
      <!-- 搜索结果将在这里显示 -->
    </div>
  </div>

  <div class="test-info">
    <h3>📋 测试步骤</h3>
    <ol>
      <li><strong>测试搜索引擎下拉框：</strong>点击Google图标左侧区域，应该能看到搜索引擎选项</li>
      <li><strong>测试搜索功能：</strong>在搜索框中输入"知乎"，应该能看到搜索结果下拉框</li>
      <li><strong>测试圆角：</strong>搜索结果显示时，下拉框应该有完整的底部圆角</li>
      <li><strong>测试布局：</strong>搜索结果显示时，不应该挤压下面的内容</li>
    </ol>
  </div>

  <script>
    // 模拟存储管理器
    const mockStorageManager = {
      data: {
        categories: [
          {
            id: 'cat-1',
            name: '社交媒体',
            color: '#4285f4',
            shortcuts: [
              { id: 'shortcut-1', name: '知乎', url: 'https://zhihu.com' },
              { id: 'shortcut-2', name: '微博', url: 'https://weibo.com' },
              { id: 'shortcut-3', name: '哔哩哔哩', url: 'https://bilibili.com' }
            ]
          },
          {
            id: 'cat-2',
            name: '工作',
            color: '#0f9d58',
            shortcuts: [
              { id: 'shortcut-4', name: '知识星球', url: 'https://zsxq.com' },
              { id: 'shortcut-5', name: '语雀', url: 'https://yuque.com' }
            ]
          }
        ]
      },
      getCategories() {
        return this.data.categories;
      }
    };

    // 设置全局变量
    window.storageManager = mockStorageManager;

    // 简化的搜索管理器类
    class TestSearchManager {
      constructor() {
        this.searchInput = document.getElementById('search-input');
        this.searchButton = document.querySelector('.search-button');
        this.searchEngineSelector = document.querySelector('.search-engine-selector');
        this.searchEngineIcon = document.querySelector('.search-engine-icon');
        this.searchBox = document.querySelector('.search-box');
        this.testStatus = document.getElementById('test-status');
        
        this.updateStatus('初始化搜索管理器...', 'info');
        
        // 创建搜索结果下拉框
        this.createSearchDropdown();
        
        // 搜索引擎配置
        this.searchEngines = [
          { name: 'Google', icon: 'https://www.google.com/favicon.ico' },
          { name: 'Bing', icon: 'https://www.bing.com/favicon.ico' },
          { name: 'Baidu', icon: 'https://www.baidu.com/favicon.ico' },
          { name: 'DuckDuckGo', icon: 'https://duckduckgo.com/favicon.ico' }
        ];

        this.currentSearchEngine = 0;
        this.bindEvents();
        this.updateSearchEngineIcon();
        
        this.updateStatus('✅ 搜索管理器初始化完成！现在可以测试功能了。', 'success');
      }

      updateStatus(message, type) {
        this.testStatus.textContent = message;
        this.testStatus.className = `status ${type}`;
      }

      createSearchDropdown() {
        this.searchDropdown = document.createElement('div');
        this.searchDropdown.className = 'search-dropdown';
        this.searchDropdown.style.display = 'none';
        this.searchBox.appendChild(this.searchDropdown);
      }

      bindEvents() {
        // Search input events
        if (this.searchInput) {
          this.searchInput.addEventListener('input', (e) => {
            this.handleRealTimeSearch(e.target.value);
          });
          
          this.searchInput.addEventListener('focus', () => {
            if (this.searchInput.value.trim()) {
              this.showSearchDropdown();
            }
          });
          
          this.searchInput.addEventListener('blur', () => {
            setTimeout(() => {
              this.hideSearchDropdown();
            }, 150);
          });
        }

        // Search engine selector click
        if (this.searchEngineSelector) {
          this.searchEngineSelector.addEventListener('click', (e) => {
            e.stopPropagation();
            this.updateStatus('🔄 搜索引擎选择器被点击', 'info');
            this.toggleDropdown();
          });
        }

        // Search engine options click
        const engineOptions = document.querySelectorAll('.search-engine-option');
        engineOptions.forEach((option, index) => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const engineIndex = parseInt(option.dataset.engine);
            this.updateStatus(`✅ 选择了搜索引擎: ${this.searchEngines[engineIndex].name}`, 'success');
            this.selectSearchEngine(engineIndex);
          });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          this.closeDropdown();
        });
      }

      handleRealTimeSearch(query) {
        const trimmedQuery = query.trim().toLowerCase();
        
        if (!trimmedQuery) {
          this.hideSearchDropdown();
          return;
        }

        this.updateStatus(`🔍 搜索: "${query}"`, 'info');
        this.showSearchResults(trimmedQuery);
      }

      showSearchResults(query) {
        if (!storageManager || !storageManager.data || !storageManager.data.categories) {
          this.renderSearchResults([]);
          this.showSearchDropdown();
          return;
        }
        
        const categories = storageManager.getCategories();
        let results = [];

        categories.forEach(category => {
          const matchingShortcuts = category.shortcuts.filter(shortcut =>
            shortcut.name.toLowerCase().includes(query)
          );

          matchingShortcuts.forEach(shortcut => {
            results.push({
              type: 'shortcut',
              data: shortcut,
              category: category,
              query: query
            });
          });
        });

        this.renderSearchResults(results);
        this.showSearchDropdown();
        
        if (results.length > 0) {
          this.updateStatus(`✅ 找到 ${results.length} 个匹配结果`, 'success');
        } else {
          this.updateStatus('ℹ️ 未找到匹配结果', 'info');
        }
      }

      renderSearchResults(results) {
        if (results.length === 0) {
          this.searchDropdown.innerHTML = `
            <div class="search-result-item no-results">
              <span>未找到匹配结果</span>
            </div>
          `;
          return;
        }

        this.searchDropdown.innerHTML = results.map(result => `
          <div class="search-result-item">
            <div class="result-content">
              <div class="result-title">${result.data.name}</div>
              <div class="result-subtitle">${result.category.name} • ${result.data.url}</div>
            </div>
          </div>
        `).join('');
      }

      showSearchDropdown() {
        this.searchDropdown.style.display = 'block';
        this.searchBox.classList.add('has-results');
      }

      hideSearchDropdown() {
        this.searchDropdown.style.display = 'none';
        this.searchBox.classList.remove('has-results');
      }

      toggleDropdown() {
        const isOpen = this.searchEngineSelector.classList.contains('open');
        
        if (isOpen) {
          this.closeDropdown();
        } else {
          this.searchEngineSelector.classList.add('open');
          this.updateActiveOption();
        }
      }

      closeDropdown() {
        this.searchEngineSelector.classList.remove('open');
      }

      selectSearchEngine(engineIndex) {
        this.currentSearchEngine = engineIndex;
        this.updateSearchEngineIcon();
        this.updateActiveOption();
        this.closeDropdown();
      }

      updateActiveOption() {
        const options = document.querySelectorAll('.search-engine-option');
        options.forEach((option, index) => {
          option.classList.toggle('active', index === this.currentSearchEngine);
        });
      }

      updateSearchEngineIcon() {
        if (this.searchEngineIcon) {
          const currentEngine = this.searchEngines[this.currentSearchEngine];
          this.searchEngineIcon.src = currentEngine.icon;
          this.searchEngineIcon.alt = currentEngine.name;
        }
        this.updateActiveOption();
      }
    }

    // 等待页面加载完成
    document.addEventListener('DOMContentLoaded', () => {
      const testSearchManager = new TestSearchManager();
    });
  </script>
</body>
</html>
