<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>删除事件修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .delete-btn {
            background: #dc3545;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .config-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .config-list {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>删除事件修复测试</h1>
        <p>测试修复后的配置删除功能，验证确认对话框不会重复弹出</p>

        <h3>模拟配置列表</h3>
        <div id="config-list" class="config-list">
            <!-- 配置项将在这里动态生成 -->
        </div>

        <h3>测试操作</h3>
        <button onclick="initTest()">初始化测试</button>
        <button onclick="addTestConfig()">添加测试配置</button>
        <button onclick="simulateRebind()">模拟重新绑定事件</button>
        <button onclick="checkEventListeners()">检查事件监听器数量</button>
        <button onclick="clearLog()">清空日志</button>

        <div class="log" id="log"></div>
    </div>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 模拟配置数据
        let testConfigs = [];
        let configIdCounter = 1;
        let clickHandler = null;

        // 模拟修复后的事件绑定逻辑
        function bindConfigCardEvents() {
            const configList = document.getElementById('config-list');
            if (!configList) return;

            // 移除之前的事件监听器（如果存在）
            if (clickHandler) {
                configList.removeEventListener('click', clickHandler);
                log('移除了之前的事件监听器', 'info');
            }

            // 创建新的事件处理器
            clickHandler = (e) => {
                const button = e.target.closest('.config-btn');
                if (!button) return;

                const action = button.dataset.action;
                const configId = button.dataset.configId;

                if (!action || !configId) return;

                // 防止重复点击
                if (button.disabled) return;

                log(`点击了 ${action} 按钮，配置ID: ${configId}`, 'info');

                switch (action) {
                    case 'delete':
                        deleteConfig(configId);
                        break;
                    default:
                        log(`执行操作: ${action}`, 'info');
                }
            };

            // 绑定新的事件监听器
            configList.addEventListener('click', clickHandler);
            log('绑定了新的事件监听器', 'success');
        }

        // 删除配置
        function deleteConfig(configId) {
            const config = testConfigs.find(c => c.id === configId);
            if (!config) return;

            log(`准备删除配置: ${config.name}`, 'warning');

            if (!confirm(`确定要删除配置 "${config.name}" 吗？此操作不可撤销。`)) {
                log('用户取消了删除操作', 'info');
                return;
            }

            log('用户确认删除，执行删除操作...', 'info');

            // 从数组中移除配置
            const index = testConfigs.findIndex(c => c.id === configId);
            if (index > -1) {
                testConfigs.splice(index, 1);
                log(`配置 "${config.name}" 删除成功`, 'success');
            }

            // 重新渲染配置列表（这会触发重新绑定事件）
            renderConfigList();
        }

        // 渲染配置列表
        function renderConfigList() {
            const configList = document.getElementById('config-list');
            if (!configList) return;

            if (testConfigs.length === 0) {
                configList.innerHTML = '<div class="config-item">暂无配置</div>';
                return;
            }

            configList.innerHTML = testConfigs.map(config => `
                <div class="config-item">
                    <div>
                        <strong>${config.name}</strong>
                        <small> (ID: ${config.id})</small>
                    </div>
                    <div>
                        <button class="config-btn" data-action="edit" data-config-id="${config.id}">编辑</button>
                        <button class="config-btn delete-btn" data-action="delete" data-config-id="${config.id}">删除</button>
                    </div>
                </div>
            `).join('');

            log(`渲染了 ${testConfigs.length} 个配置项`, 'info');

            // 重新绑定事件（模拟真实场景）
            bindConfigCardEvents();
        }

        // 初始化测试
        function initTest() {
            log('=== 初始化测试 ===', 'info');
            
            testConfigs = [
                { id: 'config-1', name: '测试配置1' },
                { id: 'config-2', name: '测试配置2' },
                { id: 'config-3', name: '测试配置3' }
            ];
            
            renderConfigList();
            log('测试初始化完成，请尝试删除配置', 'success');
        }

        // 添加测试配置
        function addTestConfig() {
            const newConfig = {
                id: `config-${++configIdCounter}`,
                name: `测试配置${configIdCounter}`
            };
            
            testConfigs.push(newConfig);
            renderConfigList();
            log(`添加了新配置: ${newConfig.name}`, 'success');
        }

        // 模拟重新绑定事件（不应该导致重复监听器）
        function simulateRebind() {
            log('=== 模拟重新绑定事件 ===', 'warning');
            bindConfigCardEvents();
            bindConfigCardEvents();
            bindConfigCardEvents();
            log('连续绑定了3次事件，但应该只有1个监听器生效', 'info');
        }

        // 检查事件监听器数量（简单的检查方法）
        function checkEventListeners() {
            const configList = document.getElementById('config-list');
            if (!configList) return;

            // 这是一个简化的检查，实际中很难准确计算监听器数量
            log('=== 事件监听器检查 ===', 'info');
            log('当前clickHandler引用:', clickHandler ? '存在' : '不存在', 'info');
            
            // 模拟点击测试
            const deleteBtn = configList.querySelector('.config-btn[data-action="delete"]');
            if (deleteBtn) {
                log('模拟点击删除按钮...', 'info');
                
                // 计算confirm调用次数
                let confirmCallCount = 0;
                const originalConfirm = window.confirm;
                window.confirm = function(message) {
                    confirmCallCount++;
                    log(`confirm被调用第${confirmCallCount}次: ${message}`, confirmCallCount > 1 ? 'error' : 'success');
                    return false; // 总是取消，避免实际删除
                };
                
                // 触发点击事件
                deleteBtn.click();
                
                // 恢复原始confirm
                window.confirm = originalConfirm;
                
                if (confirmCallCount === 1) {
                    log('✅ 事件监听器正常，confirm只被调用1次', 'success');
                } else {
                    log(`❌ 事件监听器重复，confirm被调用${confirmCallCount}次`, 'error');
                }
            }
        }

        // 页面加载完成
        window.addEventListener('load', () => {
            log('删除事件修复测试页面加载完成', 'info');
            log('请先点击"初始化测试"，然后尝试删除配置', 'info');
            log('注意观察确认对话框是否只弹出一次', 'info');
        });
    </script>
</body>
</html>
