<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®ä¿å­˜é€»è¾‘æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #3367d6; }
        .button.success { background: #34a853; }
        .button.warning { background: #fbbc04; color: #000; }
        .button.danger { background: #ea4335; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .status-card {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        .status-card.pass { background: #d4edda; border-color: #c3e6cb; }
        .status-card.fail { background: #f8d7da; border-color: #f5c6cb; }
        .status-card.warn { background: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¾ ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®ä¿å­˜é€»è¾‘æµ‹è¯•</h1>
        <p>æµ‹è¯•ç»Ÿä¸€ä¿å­˜å…¥å£ã€æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ã€StorageManagerä¼˜åŒ–</p>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•çŠ¶æ€</h3>
            <div id="status-overview" class="status-grid">
                <div class="status-card" id="coordinator-test">
                    <h4>ä¿å­˜åè°ƒå™¨</h4>
                    <div id="coordinator-status">æœªæµ‹è¯•</div>
                </div>
                <div class="status-card" id="consistency-test">
                    <h4>ä¸€è‡´æ€§æ£€æŸ¥</h4>
                    <div id="consistency-status">æœªæµ‹è¯•</div>
                </div>
                <div class="status-card" id="storage-test">
                    <h4>StorageManager</h4>
                    <div id="storage-status">æœªæµ‹è¯•</div>
                </div>
                <div class="status-card" id="theme-test">
                    <h4>ä¸»é¢˜ä¿å­˜</h4>
                    <div id="theme-status">æœªæµ‹è¯•</div>
                </div>
            </div>
            <button class="button success" onclick="runAllPhase3Tests()">ğŸš€ è¿è¡Œç¬¬ä¸‰é˜¶æ®µå…¨éƒ¨æµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ ä¸“é¡¹æµ‹è¯•</h3>
            <div>
                <button class="button" onclick="testDataSaveCoordinator()">ğŸ’¾ æ•°æ®ä¿å­˜åè°ƒå™¨æµ‹è¯•</button>
                <button class="button" onclick="testConsistencyChecks()">ğŸ” ä¸€è‡´æ€§æ£€æŸ¥æµ‹è¯•</button>
                <button class="button" onclick="testStorageManagerSaving()">ğŸ“¦ StorageManagerä¿å­˜æµ‹è¯•</button>
                <button class="button" onclick="testThemeSaving()">ğŸ¨ ä¸»é¢˜ä¿å­˜æµ‹è¯•</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ é«˜çº§æµ‹è¯•</h3>
            <div>
                <button class="button" onclick="testConcurrentSaves()">âš¡ å¹¶å‘ä¿å­˜æµ‹è¯•</button>
                <button class="button" onclick="testDataOverwriteProtection()">ğŸ›¡ï¸ æ•°æ®è¦†ç›–ä¿æŠ¤æµ‹è¯•</button>
                <button class="button" onclick="testSaveValidation()">âœ… ä¿å­˜éªŒè¯æµ‹è¯•</button>
                <button class="button danger" onclick="testErrorRecovery()">ğŸš¨ é”™è¯¯æ¢å¤æµ‹è¯•</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-log" class="log"></div>
            <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/utils.js"></script>
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/data-save-coordinator.js"></script>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            if (type === 'success') logEntry.style.color = '#155724';
            else if (type === 'error') logEntry.style.color = '#721c24';
            else if (type === 'warning') logEntry.style.color = '#856404';
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // æ›´æ–°çŠ¶æ€å¡ç‰‡
        function updateStatusCard(cardId, status, message) {
            const card = document.getElementById(cardId);
            const statusDiv = card.querySelector('div');
            statusDiv.textContent = message;
            
            card.className = 'status-card';
            if (status === 'pass') card.classList.add('pass');
            else if (status === 'fail') card.classList.add('fail');
            else if (status === 'warn') card.classList.add('warn');
        }

        // è¿è¡Œæ‰€æœ‰ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•
        async function runAllPhase3Tests() {
            try {
                log('ğŸš€ å¼€å§‹ç¬¬ä¸‰é˜¶æ®µå…¨éƒ¨æµ‹è¯•...', 'info');
                
                // é‡ç½®çŠ¶æ€
                ['coordinator-test', 'consistency-test', 'storage-test', 'theme-test'].forEach(id => {
                    updateStatusCard(id, '', 'æµ‹è¯•ä¸­...');
                });
                
                // 1. æ•°æ®ä¿å­˜åè°ƒå™¨æµ‹è¯•
                log('ğŸ’¾ æµ‹è¯•æ•°æ®ä¿å­˜åè°ƒå™¨...', 'info');
                const coordinatorResult = await testDataSaveCoordinator();
                updateStatusCard('coordinator-test', coordinatorResult.status, coordinatorResult.message);
                
                // 2. ä¸€è‡´æ€§æ£€æŸ¥æµ‹è¯•
                log('ğŸ” æµ‹è¯•ä¸€è‡´æ€§æ£€æŸ¥...', 'info');
                const consistencyResult = await testConsistencyChecks();
                updateStatusCard('consistency-test', consistencyResult.status, consistencyResult.message);
                
                // 3. StorageManageræµ‹è¯•
                log('ğŸ“¦ æµ‹è¯•StorageManager...', 'info');
                const storageResult = await testStorageManagerSaving();
                updateStatusCard('storage-test', storageResult.status, storageResult.message);
                
                // 4. ä¸»é¢˜ä¿å­˜æµ‹è¯•
                log('ğŸ¨ æµ‹è¯•ä¸»é¢˜ä¿å­˜...', 'info');
                const themeResult = await testThemeSaving();
                updateStatusCard('theme-test', themeResult.status, themeResult.message);
                
                // æ€»ç»“
                const allResults = [coordinatorResult, consistencyResult, storageResult, themeResult];
                const passCount = allResults.filter(r => r.status === 'pass').length;
                const failCount = allResults.filter(r => r.status === 'fail').length;
                const warnCount = allResults.filter(r => r.status === 'warn').length;
                
                log(`ğŸ‰ ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•å®Œæˆï¼é€šè¿‡: ${passCount}, è­¦å‘Š: ${warnCount}, å¤±è´¥: ${failCount}`, 
                    failCount > 0 ? 'error' : warnCount > 0 ? 'warning' : 'success');
                
            } catch (error) {
                log(`âŒ ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ•°æ®ä¿å­˜åè°ƒå™¨æµ‹è¯•
        async function testDataSaveCoordinator() {
            try {
                log('ğŸ’¾ å¼€å§‹æ•°æ®ä¿å­˜åè°ƒå™¨æµ‹è¯•...', 'info');
                
                if (!window.dataSaveCoordinator) {
                    return { status: 'fail', message: 'æ•°æ®ä¿å­˜åè°ƒå™¨ä¸å¯ç”¨' };
                }
                
                // æµ‹è¯•åŸºæœ¬ä¿å­˜åŠŸèƒ½
                const testData = {
                    categories: [{ id: 'test', name: 'æµ‹è¯•åˆ†ç±»', shortcuts: [] }],
                    settings: { viewMode: 'grid' }
                };
                
                log('  æµ‹è¯•åŸºæœ¬ä¿å­˜åŠŸèƒ½...', 'info');
                const result = await dataSaveCoordinator.saveData(testData, {
                    source: 'test',
                    priority: 'normal',
                    mergeStrategy: 'smart'
                });
                
                if (result && result.success) {
                    log('  âœ… åŸºæœ¬ä¿å­˜åŠŸèƒ½æ­£å¸¸', 'success');
                } else {
                    return { status: 'fail', message: 'åŸºæœ¬ä¿å­˜åŠŸèƒ½å¤±è´¥' };
                }
                
                // æµ‹è¯•ä¿å­˜çŠ¶æ€
                const status = dataSaveCoordinator.getSaveStatus();
                log(`  ä¿å­˜çŠ¶æ€: é˜Ÿåˆ—é•¿åº¦=${status.queueLength}, è¿›è¡Œä¸­=${status.saveInProgress}`, 'info');
                
                return { status: 'pass', message: 'åè°ƒå™¨åŠŸèƒ½æ­£å¸¸' };
                
            } catch (error) {
                return { status: 'fail', message: `æµ‹è¯•å¤±è´¥: ${error.message}` };
            }
        }

        // ä¸€è‡´æ€§æ£€æŸ¥æµ‹è¯•
        async function testConsistencyChecks() {
            try {
                log('ğŸ” å¼€å§‹ä¸€è‡´æ€§æ£€æŸ¥æµ‹è¯•...', 'info');
                
                if (!window.syncManager || typeof syncManager.performConsistencyCheck !== 'function') {
                    return { status: 'fail', message: 'ä¸€è‡´æ€§æ£€æŸ¥åŠŸèƒ½ä¸å¯ç”¨' };
                }
                
                // æµ‹è¯•æ­£å¸¸æ•°æ®
                log('  æµ‹è¯•æ­£å¸¸æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥...', 'info');
                const normalData = {
                    categories: [{ id: 'test', name: 'æµ‹è¯•' }],
                    settings: { viewMode: 'grid' },
                    themeSettings: { theme: 'blue' }
                };
                
                const normalResult = await syncManager.performConsistencyCheck(normalData);
                log(`  æ­£å¸¸æ•°æ®æ£€æŸ¥ç»“æœ: ${normalResult.passed ? 'é€šè¿‡' : 'å¤±è´¥'}, è­¦å‘Šæ•°: ${normalResult.warnings.length}`, 'info');
                
                // æµ‹è¯•å¼‚å¸¸æ•°æ®
                log('  æµ‹è¯•å¼‚å¸¸æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥...', 'info');
                const badData = null;
                
                const badResult = await syncManager.performConsistencyCheck(badData);
                log(`  å¼‚å¸¸æ•°æ®æ£€æŸ¥ç»“æœ: ${badResult.passed ? 'é€šè¿‡' : 'å¤±è´¥'}, è­¦å‘Šæ•°: ${badResult.warnings.length}`, 'info');
                
                if (!badResult.passed) {
                    log('  âœ… å¼‚å¸¸æ•°æ®æ­£ç¡®è¢«æ£€æµ‹', 'success');
                    return { status: 'pass', message: 'ä¸€è‡´æ€§æ£€æŸ¥æ­£å¸¸' };
                } else {
                    return { status: 'warn', message: 'å¼‚å¸¸æ•°æ®æœªè¢«æ£€æµ‹' };
                }
                
            } catch (error) {
                return { status: 'fail', message: `æµ‹è¯•å¤±è´¥: ${error.message}` };
            }
        }

        // StorageManagerä¿å­˜æµ‹è¯•
        async function testStorageManagerSaving() {
            try {
                log('ğŸ“¦ å¼€å§‹StorageManagerä¿å­˜æµ‹è¯•...', 'info');
                
                if (!window.storageManager) {
                    return { status: 'fail', message: 'StorageManagerä¸å¯ç”¨' };
                }
                
                // ä¿å­˜æµ‹è¯•æ•°æ®
                const originalCategories = storageManager.data.categories;
                const testCategories = [
                    { id: 'test-cat', name: 'æµ‹è¯•åˆ†ç±»', shortcuts: [] }
                ];
                
                log('  è®¾ç½®æµ‹è¯•æ•°æ®...', 'info');
                storageManager.data.categories = testCategories;
                
                log('  æ‰§è¡Œä¿å­˜æ“ä½œ...', 'info');
                await storageManager.saveToStorage();
                
                // éªŒè¯ä¿å­˜ç»“æœ
                log('  éªŒè¯ä¿å­˜ç»“æœ...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…ä¿å­˜å®Œæˆ
                
                // é‡æ–°åŠ è½½æ•°æ®éªŒè¯
                if (window.syncManager) {
                    const savedData = await syncManager.loadData(false);
                    if (savedData && savedData.categories && savedData.categories.length > 0) {
                        log('  âœ… StorageManagerä¿å­˜éªŒè¯é€šè¿‡', 'success');
                        
                        // æ¢å¤åŸå§‹æ•°æ®
                        storageManager.data.categories = originalCategories;
                        await storageManager.saveToStorage();
                        
                        return { status: 'pass', message: 'StorageManagerä¿å­˜æ­£å¸¸' };
                    } else {
                        return { status: 'fail', message: 'ä¿å­˜æ•°æ®éªŒè¯å¤±è´¥' };
                    }
                } else {
                    return { status: 'warn', message: 'SyncManagerä¸å¯ç”¨ï¼Œæ— æ³•éªŒè¯' };
                }
                
            } catch (error) {
                return { status: 'fail', message: `æµ‹è¯•å¤±è´¥: ${error.message}` };
            }
        }

        // ä¸»é¢˜ä¿å­˜æµ‹è¯•
        async function testThemeSaving() {
            try {
                log('ğŸ¨ å¼€å§‹ä¸»é¢˜ä¿å­˜æµ‹è¯•...', 'info');
                
                if (typeof saveThemeSettingsUnified !== 'function') {
                    return { status: 'fail', message: 'ä¸»é¢˜ä¿å­˜å‡½æ•°ä¸å¯ç”¨' };
                }
                
                // ä¿å­˜å½“å‰ä¸»é¢˜çŠ¶æ€
                const originalTheme = window.currentTheme;
                const originalOpacity = window.currentBgOpacity;
                
                // è®¾ç½®æµ‹è¯•ä¸»é¢˜
                const testTheme = 'test-theme';
                const testOpacity = 75;
                
                log(`  è®¾ç½®æµ‹è¯•ä¸»é¢˜: ${testTheme}, é€æ˜åº¦: ${testOpacity}%`, 'info');
                window.currentTheme = testTheme;
                window.currentBgOpacity = testOpacity;
                
                log('  æ‰§è¡Œä¸»é¢˜ä¿å­˜...', 'info');
                await saveThemeSettingsUnified();
                
                // éªŒè¯ä¿å­˜ç»“æœ
                log('  éªŒè¯ä¸»é¢˜ä¿å­˜ç»“æœ...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…ä¿å­˜å®Œæˆ
                
                if (window.syncManager) {
                    const savedData = await syncManager.loadData(false);
                    if (savedData && savedData.themeSettings) {
                        const savedTheme = savedData.themeSettings.theme;
                        const savedOpacity = savedData.themeSettings.backgroundOpacity;
                        
                        if (savedTheme === testTheme && savedOpacity == testOpacity) {
                            log('  âœ… ä¸»é¢˜ä¿å­˜éªŒè¯é€šè¿‡', 'success');
                            
                            // æ¢å¤åŸå§‹ä¸»é¢˜
                            window.currentTheme = originalTheme;
                            window.currentBgOpacity = originalOpacity;
                            await saveThemeSettingsUnified();
                            
                            return { status: 'pass', message: 'ä¸»é¢˜ä¿å­˜æ­£å¸¸' };
                        } else {
                            return { status: 'fail', message: `ä¸»é¢˜ä¿å­˜ä¸åŒ¹é…: æœŸæœ›${testTheme}/${testOpacity}, å®é™…${savedTheme}/${savedOpacity}` };
                        }
                    } else {
                        return { status: 'fail', message: 'ä¸»é¢˜è®¾ç½®æœªä¿å­˜' };
                    }
                } else {
                    return { status: 'warn', message: 'SyncManagerä¸å¯ç”¨ï¼Œæ— æ³•éªŒè¯' };
                }
                
            } catch (error) {
                return { status: 'fail', message: `æµ‹è¯•å¤±è´¥: ${error.message}` };
            }
        }

        // å¹¶å‘ä¿å­˜æµ‹è¯•
        async function testConcurrentSaves() {
            try {
                log('âš¡ å¼€å§‹å¹¶å‘ä¿å­˜æµ‹è¯•...', 'info');
                
                if (!window.dataSaveCoordinator) {
                    log('âŒ æ•°æ®ä¿å­˜åè°ƒå™¨ä¸å¯ç”¨', 'error');
                    return;
                }
                
                // åˆ›å»ºå¤šä¸ªå¹¶å‘ä¿å­˜è¯·æ±‚
                const promises = [];
                for (let i = 0; i < 5; i++) {
                    const testData = {
                        categories: [{ id: `test-${i}`, name: `æµ‹è¯•${i}` }],
                        settings: { viewMode: 'grid' }
                    };
                    
                    promises.push(dataSaveCoordinator.saveData(testData, {
                        source: `test-${i}`,
                        priority: i === 0 ? 'high' : 'normal'
                    }));
                }
                
                log('  å‘èµ·5ä¸ªå¹¶å‘ä¿å­˜è¯·æ±‚...', 'info');
                const results = await Promise.all(promises);
                
                const successCount = results.filter(r => r && r.success).length;
                log(`  å¹¶å‘ä¿å­˜å®Œæˆ: ${successCount}/5 æˆåŠŸ`, successCount === 5 ? 'success' : 'warning');
                
            } catch (error) {
                log(`âŒ å¹¶å‘ä¿å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ•°æ®è¦†ç›–ä¿æŠ¤æµ‹è¯•
        async function testDataOverwriteProtection() {
            try {
                log('ğŸ›¡ï¸ å¼€å§‹æ•°æ®è¦†ç›–ä¿æŠ¤æµ‹è¯•...', 'info');
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„è¦†ç›–ä¿æŠ¤æµ‹è¯•
                log('  æ•°æ®è¦†ç›–ä¿æŠ¤æµ‹è¯•éœ€è¦æ›´å¤šå®ç°...', 'warning');
                
            } catch (error) {
                log(`âŒ æ•°æ®è¦†ç›–ä¿æŠ¤æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¿å­˜éªŒè¯æµ‹è¯•
        async function testSaveValidation() {
            try {
                log('âœ… å¼€å§‹ä¿å­˜éªŒè¯æµ‹è¯•...', 'info');
                
                if (!window.dataSaveCoordinator) {
                    log('âŒ æ•°æ®ä¿å­˜åè°ƒå™¨ä¸å¯ç”¨', 'error');
                    return;
                }
                
                // æµ‹è¯•æ— æ•ˆæ•°æ®éªŒè¯
                log('  æµ‹è¯•æ— æ•ˆæ•°æ®éªŒè¯...', 'info');
                try {
                    await dataSaveCoordinator.saveData(null, { source: 'test' });
                    log('  âš ï¸ æ— æ•ˆæ•°æ®æœªè¢«æ‹’ç»', 'warning');
                } catch (error) {
                    log('  âœ… æ— æ•ˆæ•°æ®æ­£ç¡®è¢«æ‹’ç»', 'success');
                }
                
            } catch (error) {
                log(`âŒ ä¿å­˜éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é”™è¯¯æ¢å¤æµ‹è¯•
        async function testErrorRecovery() {
            try {
                log('ğŸš¨ å¼€å§‹é”™è¯¯æ¢å¤æµ‹è¯•...', 'info');
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ é”™è¯¯æ¢å¤æµ‹è¯•
                log('  é”™è¯¯æ¢å¤æµ‹è¯•éœ€è¦æ›´å¤šå®ç°...', 'warning');
                
            } catch (error) {
                log(`âŒ é”™è¯¯æ¢å¤æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                log('ğŸš€ åˆå§‹åŒ–ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•å·¥å…·...', 'info');
                
                await storageManager.init();
                if (typeof initThemeSettings === 'function') {
                    await initThemeSettings();
                }
                
                log('âœ… ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
