<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>完整搜索功能诊断</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="fonts/material-symbols-rounded.css">
  <style>
    .diagnostic-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px;
      z-index: 10000;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .diagnostic-overlay h3 {
      margin: 0 0 10px 0;
      color: #4285f4;
    }
    .diagnostic-status {
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
    }
    .diagnostic-success { background: rgba(40, 167, 69, 0.3); }
    .diagnostic-error { background: rgba(220, 53, 69, 0.3); }
    .diagnostic-info { background: rgba(23, 162, 184, 0.3); }
    .diagnostic-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 10001;
    }
  </style>
</head>
<body class="theme-default">
  <button class="diagnostic-toggle" onclick="toggleDiagnostic()">诊断面板</button>
  
  <div id="diagnostic-overlay" class="diagnostic-overlay" style="display: none;">
    <h3>🔧 实时诊断信息</h3>
    <div id="diagnostic-content"></div>
  </div>

  <!-- 完整的HTML结构 - 从index.html复制 -->
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Quick Tab</h1>
      </div>
      <div class="header-right">
        <div class="view-controls">
          <button id="grid-view-btn" class="view-btn active" title="网格视图">
            <span class="material-symbols-rounded">grid_view</span>
          </button>
          <button id="list-view-btn" class="view-btn" title="列表视图">
            <span class="material-symbols-rounded">view_list</span>
          </button>
        </div>
        <button id="add-category-btn" class="add-btn" title="添加分类">
          <span class="material-symbols-rounded">add</span>
        </button>
        <button id="sync-btn" class="sync-btn" title="同步数据">
          <span class="material-symbols-rounded">sync</span>
        </button>
        <button id="settings-btn" class="settings-btn" title="设置">
          <span class="material-symbols-rounded">settings</span>
        </button>
      </div>
    </header>

    <!-- Search Box -->
    <div class="search-container">
      <div class="search-box">
        <div class="search-input-row">
          <div class="search-engine-selector">
            <img src="https://www.google.com/favicon.ico" alt="Google" class="search-engine-icon">
            <span class="search-engine-dropdown">
              <span class="material-symbols-rounded">expand_more</span>
            </span>
            <!-- 下拉菜单 -->
            <div class="search-engine-dropdown-menu">
              <div class="search-engine-option" data-engine="0">
                <img src="https://www.google.com/favicon.ico" alt="Google">
                <span>Google</span>
              </div>
              <div class="search-engine-option" data-engine="1">
                <img src="https://www.bing.com/favicon.ico" alt="Bing">
                <span>Bing</span>
              </div>
              <div class="search-engine-option" data-engine="2">
                <img src="https://www.baidu.com/favicon.ico" alt="Baidu">
                <span>百度</span>
              </div>
              <div class="search-engine-option" data-engine="3">
                <img src="https://duckduckgo.com/favicon.ico" alt="DuckDuckGo">
                <span>DuckDuckGo</span>
              </div>
            </div>
          </div>
          <div class="search-input-container">
            <input type="text" id="search-input" placeholder="搜索快捷方式和分类...">
          </div>
          <button class="search-button" type="button">
            <span class="material-symbols-rounded">search</span>
          </button>
        </div>
        <!-- 搜索结果将在这里显示 -->
      </div>
    </div>

    <!-- Categories Container -->
    <div id="categories-container" class="grid-view">
      <!-- Categories will be rendered here -->
    </div>
  </div>

  <!-- 所有必要的模态框 -->
  <!-- Category Modal -->
  <div id="category-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="category-modal-title">添加分类</h2>
        <button class="close-modal">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <form id="category-form">
        <input type="hidden" id="category-id">
        <div class="form-group">
          <label for="category-name">分类名称</label>
          <input type="text" id="category-name" required>
        </div>
        <div class="form-group">
          <label for="category-color">分类颜色</label>
          <input type="color" id="category-color" value="#4285f4">
        </div>
        <div class="form-actions">
          <button type="button" id="delete-category-btn" class="delete-btn">删除</button>
          <button type="submit" class="save-btn">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Shortcut Modal -->
  <div id="shortcut-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="shortcut-modal-title">添加快捷方式</h2>
        <button class="close-modal">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <form id="shortcut-form">
        <input type="hidden" id="shortcut-id">
        <input type="hidden" id="shortcut-category-id">
        <div class="form-group">
          <label for="shortcut-name">名称</label>
          <input type="text" id="shortcut-name" required>
        </div>
        <div class="form-group">
          <label for="shortcut-url">网址</label>
          <div class="url-input-group">
            <input type="url" id="shortcut-url" required>
            <button type="button" id="fetch-url-info">
              <span class="material-symbols-rounded">download</span>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>图标类型</label>
          <div class="icon-type-options">
            <label>
              <input type="radio" name="icon-type" value="letter" id="icon-type-letter" checked>
              <span>字母图标</span>
            </label>
            <label>
              <input type="radio" name="icon-type" value="favicon" id="icon-type-favicon">
              <span>网站图标</span>
            </label>
            <label>
              <input type="radio" name="icon-type" value="custom" id="icon-type-custom">
              <span>自定义图标</span>
            </label>
          </div>
        </div>
        <div id="letter-icon-form" class="icon-form">
          <div class="form-group">
            <label for="shortcut-color">图标颜色</label>
            <input type="color" id="shortcut-color" value="#4285f4">
          </div>
        </div>
        <div id="favicon-preview" class="icon-form hidden">
          <div class="form-group">
            <label>网站图标预览</label>
            <img id="favicon-image" alt="Favicon preview">
          </div>
        </div>
        <div id="custom-icon-form" class="icon-form hidden">
          <div class="form-group">
            <label for="shortcut-icon-url">图标网址</label>
            <input type="url" id="shortcut-icon-url">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" id="delete-shortcut-btn" class="delete-btn">删除</button>
          <button type="submit" class="save-btn">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>设置</h2>
        <button class="close-modal">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <div class="settings-content">
        <div class="settings-section">
          <h3>主题设置</h3>
          <div class="theme-options">
            <label>
              <input type="radio" name="theme" value="default" checked>
              <span>默认主题</span>
            </label>
            <label>
              <input type="radio" name="theme" value="dark">
              <span>深色主题</span>
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h3>数据同步</h3>
          <div id="sync-settings">
            <!-- Sync settings will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 加载所有JavaScript文件 -->
  <script src="js/supabase.min.js"></script>
  <script src="js/icons.js"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/sync-manager.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/sync-ui.js"></script>
  <script src="js/category.js"></script>
  <script src="js/shortcut.js"></script>
  <script src="js/search.js"></script>
  <script src="js/view.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/main.js"></script>

  <script>
    let diagnosticVisible = false;
    const diagnosticContent = document.getElementById('diagnostic-content');

    function toggleDiagnostic() {
      const overlay = document.getElementById('diagnostic-overlay');
      diagnosticVisible = !diagnosticVisible;
      overlay.style.display = diagnosticVisible ? 'block' : 'none';
      
      if (diagnosticVisible) {
        runDiagnostics();
      }
    }

    function addDiagnostic(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `diagnostic-status diagnostic-${type}`;
      div.textContent = message;
      diagnosticContent.appendChild(div);
    }

    function runDiagnostics() {
      diagnosticContent.innerHTML = '';
      
      // 检查管理器实例
      const managers = [
        { name: 'storageManager', obj: window.storageManager },
        { name: 'searchManager', obj: window.searchManager },
        { name: 'categoryManager', obj: window.categoryManager },
        { name: 'shortcutManager', obj: window.shortcutManager },
        { name: 'viewManager', obj: window.viewManager }
      ];

      managers.forEach(manager => {
        if (manager.obj) {
          addDiagnostic(`✅ ${manager.name} 已创建`, 'success');
        } else {
          addDiagnostic(`❌ ${manager.name} 未创建`, 'error');
        }
      });

      // 检查DOM元素
      const elements = [
        'search-input',
        'search-engine-selector',
        'categories-container'
      ];

      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          addDiagnostic(`✅ #${id} 存在`, 'success');
        } else {
          addDiagnostic(`❌ #${id} 不存在`, 'error');
        }
      });

      // 测试搜索引擎下拉框
      const selector = document.querySelector('.search-engine-selector');
      if (selector) {
        addDiagnostic('🔄 测试搜索引擎下拉框...', 'info');
        selector.click();
        
        setTimeout(() => {
          const isOpen = selector.classList.contains('open');
          if (isOpen) {
            addDiagnostic('✅ 搜索引擎下拉框工作正常', 'success');
            selector.click(); // 关闭
          } else {
            addDiagnostic('❌ 搜索引擎下拉框无响应', 'error');
          }
        }, 100);
      }

      // 测试搜索功能
      const searchInput = document.getElementById('search-input');
      if (searchInput && window.searchManager) {
        addDiagnostic('🔄 测试搜索功能...', 'info');
        searchInput.value = '测试';
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        
        setTimeout(() => {
          const dropdown = document.querySelector('.search-dropdown');
          if (dropdown && dropdown.style.display !== 'none') {
            addDiagnostic('✅ 搜索功能工作正常', 'success');
          } else {
            addDiagnostic('❌ 搜索功能无响应', 'error');
          }
        }, 100);
      }
    }

    // 监听初始化完成
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (diagnosticVisible) {
          runDiagnostics();
        }
      }, 2000);
    });
  </script>
</body>
</html>
