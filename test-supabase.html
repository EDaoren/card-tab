<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase连接测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #4285f4;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #3367d6;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .sql-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Supabase连接测试工具</h1>
    <p>用于测试Quick Nav Tab插件的Supabase配置是否正确</p>

    <form id="test-form">
      <div class="form-group">
        <label for="supabase-url">Supabase项目URL:</label>
        <input type="text" id="supabase-url" placeholder="https://your-project.supabase.co" required>
      </div>

      <div class="form-group">
        <label for="supabase-key">匿名密钥 (anon key):</label>
        <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
      </div>

      <div class="form-group">
        <label for="user-id">用户标识:</label>
        <input type="text" id="user-id" placeholder="test-user@example.com" required>
      </div>

      <button type="button" id="test-connection">测试连接</button>
      <button type="button" id="test-table">测试数据表</button>
      <button type="button" id="test-crud">测试读写</button>
      <button type="button" id="clear-result">清除结果</button>
    </form>

    <div id="result" class="result" style="display: none;"></div>

    <div class="sql-section">
      <h2>数据表创建脚本</h2>
      <p>如果测试失败，请在Supabase SQL编辑器中执行以下脚本：</p>
      <pre id="sql-script">-- 创建Quick Nav Tab数据表
CREATE TABLE IF NOT EXISTS quick_nav_data (
  id SERIAL PRIMARY KEY,
  user_id TEXT NOT NULL UNIQUE,
  data JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_quick_nav_data_user_id ON quick_nav_data(user_id);
CREATE INDEX IF NOT EXISTS idx_quick_nav_data_updated_at ON quick_nav_data(updated_at);

-- 启用行级安全策略（可选）
ALTER TABLE quick_nav_data ENABLE ROW LEVEL SECURITY;

-- 创建策略允许用户访问自己的数据（可选）
CREATE POLICY "Users can access own data" ON quick_nav_data
  FOR ALL USING (user_id = current_setting('app.current_user_id', true));</pre>
      <button type="button" id="copy-sql">复制SQL脚本</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let supabaseClient = null;

    function showResult(message, type = 'info') {
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = message;
      resultDiv.className = `result ${type}`;
      resultDiv.style.display = 'block';
    }

    function getFormData() {
      return {
        url: document.getElementById('supabase-url').value.trim(),
        key: document.getElementById('supabase-key').value.trim(),
        userId: document.getElementById('user-id').value.trim()
      };
    }

    async function testConnection() {
      const { url, key, userId } = getFormData();
      
      if (!url || !key || !userId) {
        showResult('请填写所有必需字段', 'error');
        return;
      }

      try {
        showResult('正在测试连接...', 'info');
        
        supabaseClient = supabase.createClient(url, key);
        
        // 简单的连接测试
        const { data, error } = await supabaseClient
          .from('quick_nav_data')
          .select('id')
          .limit(1);

        if (error) {
          if (error.code === 'PGRST116') {
            showResult('连接成功，但数据表不存在。请执行下方的SQL脚本创建数据表。', 'error');
          } else {
            showResult(`连接失败: ${error.message}`, 'error');
          }
        } else {
          showResult('✅ 连接成功！Supabase配置正确。', 'success');
        }
      } catch (error) {
        showResult(`连接错误: ${error.message}`, 'error');
      }
    }

    async function testTable() {
      if (!supabaseClient) {
        showResult('请先测试连接', 'error');
        return;
      }

      try {
        showResult('正在测试数据表结构...', 'info');
        
        const { data, error } = await supabaseClient
          .from('quick_nav_data')
          .select('*')
          .limit(1);

        if (error) {
          showResult(`数据表测试失败: ${error.message}`, 'error');
        } else {
          showResult('✅ 数据表结构正确！', 'success');
        }
      } catch (error) {
        showResult(`数据表测试错误: ${error.message}`, 'error');
      }
    }

    async function testCRUD() {
      if (!supabaseClient) {
        showResult('请先测试连接', 'error');
        return;
      }

      const { userId } = getFormData();
      const testData = {
        categories: [
          {
            id: 'test-cat-1',
            name: '测试分类',
            color: '#4285f4',
            collapsed: false,
            shortcuts: [
              {
                id: 'test-shortcut-1',
                name: '测试网站',
                url: 'https://example.com',
                iconType: 'letter',
                iconColor: '#4285f4',
                iconUrl: ''
              }
            ]
          }
        ],
        settings: {
          viewMode: 'grid'
        }
      };

      try {
        showResult('正在测试数据读写...', 'info');

        // 测试写入
        const { error: insertError } = await supabaseClient
          .from('quick_nav_data')
          .upsert({
            user_id: userId,
            data: testData,
            updated_at: new Date().toISOString()
          });

        if (insertError) {
          showResult(`写入测试失败: ${insertError.message}`, 'error');
          return;
        }

        // 测试读取
        const { data: readData, error: readError } = await supabaseClient
          .from('quick_nav_data')
          .select('data')
          .eq('user_id', userId)
          .single();

        if (readError) {
          showResult(`读取测试失败: ${readError.message}`, 'error');
          return;
        }

        // 清理测试数据
        await supabaseClient
          .from('quick_nav_data')
          .delete()
          .eq('user_id', userId);

        showResult('✅ 数据读写测试成功！所有功能正常。', 'success');
      } catch (error) {
        showResult(`CRUD测试错误: ${error.message}`, 'error');
      }
    }

    function clearResult() {
      document.getElementById('result').style.display = 'none';
    }

    function copySQLScript() {
      const sqlScript = document.getElementById('sql-script').textContent;
      navigator.clipboard.writeText(sqlScript).then(() => {
        alert('SQL脚本已复制到剪贴板！');
      }).catch(() => {
        alert('复制失败，请手动复制');
      });
    }

    // 事件监听器
    document.getElementById('test-connection').addEventListener('click', testConnection);
    document.getElementById('test-table').addEventListener('click', testTable);
    document.getElementById('test-crud').addEventListener('click', testCRUD);
    document.getElementById('clear-result').addEventListener('click', clearResult);
    document.getElementById('copy-sql').addEventListener('click', copySQLScript);
  </script>
</body>
</html>
