<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旁路缓存模式测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-item {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .status-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .status-value {
            font-weight: bold;
            color: #007cba;
        }
        .test-scenario {
            border-left: 4px solid #007cba;
            padding-left: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>🧪 旁路缓存模式测试工具</h1>
    
    <div class="container">
        <h2>📋 连接配置</h2>
        <div class="form-group">
            <label for="supabase-url">Supabase URL:</label>
            <input type="text" id="supabase-url" placeholder="https://your-project.supabase.co">
        </div>
        <div class="form-group">
            <label for="supabase-key">Supabase Anon Key:</label>
            <input type="text" id="supabase-key" placeholder="your-anon-key">
        </div>
        <div class="form-group">
            <label for="user-id">用户ID:</label>
            <input type="text" id="user-id" placeholder="test-user-123" value="test-user-123">
        </div>
        <button onclick="initializeSystem()">🔗 初始化系统</button>
        <div id="init-result"></div>
    </div>

    <div class="container">
        <h2>📊 系统状态</h2>
        <div class="status-grid">
            <div class="status-item">
                <h4>Supabase状态</h4>
                <div id="supabase-status" class="status-value">未连接</div>
            </div>
            <div class="status-item">
                <h4>Chrome Storage状态</h4>
                <div id="chrome-status" class="status-value">未知</div>
            </div>
            <div class="status-item">
                <h4>缓存模式</h4>
                <div id="cache-mode" class="status-value">未启用</div>
            </div>
            <div class="status-item">
                <h4>最后同步时间</h4>
                <div id="last-sync" class="status-value">从未同步</div>
            </div>
        </div>
        <button onclick="updateStatus()">🔄 刷新状态</button>
    </div>

    <div class="container">
        <h2>🧪 旁路缓存测试场景</h2>
        
        <div class="test-scenario">
            <h3>场景1：读取缓存命中</h3>
            <p>测试从Chrome Storage缓存读取数据</p>
            <button onclick="testCacheHit()">测试缓存命中</button>
            <div id="cache-hit-result"></div>
        </div>

        <div class="test-scenario">
            <h3>场景2：读取缓存未命中</h3>
            <p>清除缓存后从Supabase读取并缓存</p>
            <button onclick="testCacheMiss()">测试缓存未命中</button>
            <div id="cache-miss-result"></div>
        </div>

        <div class="test-scenario">
            <h3>场景3：写入并清除缓存</h3>
            <p>保存数据到Supabase并清除Chrome Storage缓存</p>
            <button onclick="testWriteAndClearCache()">测试写入清缓存</button>
            <div id="write-clear-result"></div>
        </div>

        <div class="test-scenario">
            <h3>场景4：数据一致性验证</h3>
            <p>验证Chrome Storage和Supabase数据一致性</p>
            <button onclick="testDataConsistency()">测试数据一致性</button>
            <div id="consistency-result"></div>
        </div>

        <div class="test-scenario">
            <h3>场景5：新增配置测试</h3>
            <p>测试新增配置的旁路缓存模式</p>
            <button onclick="testAddConfig()">测试新增配置</button>
            <div id="add-config-result"></div>
        </div>

        <div class="test-scenario">
            <h3>场景6：删除配置测试</h3>
            <p>测试删除配置的旁路缓存模式</p>
            <button onclick="testDeleteConfig()">测试删除配置</button>
            <div id="delete-config-result"></div>
        </div>

        <div class="test-scenario">
            <h3>场景7：配置列表查询测试</h3>
            <p>测试直接从Supabase查询配置列表</p>
            <button onclick="testConfigListQuery()">测试配置列表查询</button>
            <div id="config-list-result"></div>
        </div>
    </div>

    <div class="container">
        <h2>📝 测试数据</h2>
        <div class="form-group">
            <label for="test-data">测试数据 (JSON):</label>
            <textarea id="test-data" rows="8" placeholder='{"categories": [], "settings": {"viewMode": "grid"}, "themeSettings": {"theme": "blue"}}'></textarea>
        </div>
        <button onclick="saveTestData()">💾 保存测试数据</button>
        <button onclick="loadTestData()">📥 加载测试数据</button>
        <button onclick="clearAllData()">🗑️ 清除所有数据</button>
        <div id="data-result"></div>
    </div>

    <!-- 引入必要的JS文件 -->
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme-config-ui.js"></script>

    <script>
        let testData = {
            categories: [
                {
                    id: 'test-cat',
                    name: '测试分类',
                    color: '#007cba',
                    shortcuts: [
                        { id: 'test-sc', name: '测试链接', url: 'https://example.com' }
                    ]
                }
            ],
            settings: { viewMode: 'grid' },
            themeSettings: { 
                theme: 'blue',
                backgroundOpacity: 30,
                lastModified: new Date().toISOString()
            }
        };

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function getFormData() {
            return {
                url: document.getElementById('supabase-url').value.trim(),
                anonKey: document.getElementById('supabase-key').value.trim(),
                userId: document.getElementById('user-id').value.trim()
            };
        }

        async function initializeSystem() {
            const config = getFormData();
            
            if (!config.url || !config.anonKey || !config.userId) {
                showResult('init-result', '请填写完整的连接信息', 'error');
                return;
            }

            try {
                showResult('init-result', '正在初始化系统...', 'info');
                
                // 初始化Supabase客户端
                await supabaseClient.initialize(config);
                
                // 初始化SyncManager
                await syncManager.init();

                // 初始化ThemeConfigManager
                await themeConfigManager.init();

                // 启用Supabase同步
                await syncManager.enableSupabaseSync(config);
                
                showResult('init-result', '✅ 系统初始化成功！旁路缓存模式已启用', 'success');
                
                // 设置默认测试数据
                document.getElementById('test-data').value = JSON.stringify(testData, null, 2);
                
                // 更新状态
                updateStatus();
                
            } catch (error) {
                showResult('init-result', `❌ 初始化失败: ${error.message}`, 'error');
            }
        }

        function updateStatus() {
            try {
                const status = syncManager.getSyncStatus();
                
                document.getElementById('supabase-status').textContent = 
                    status.isSupabaseEnabled ? '已连接' : '未连接';
                
                document.getElementById('chrome-status').textContent = 
                    chrome && chrome.storage ? '可用' : '不可用';
                
                document.getElementById('cache-mode').textContent = 
                    status.isSupabaseEnabled ? '旁路缓存模式' : '仅本地模式';
                
                document.getElementById('last-sync').textContent = 
                    status.lastSyncTime || '从未同步';
                    
            } catch (error) {
                console.error('更新状态失败:', error);
            }
        }

        async function testCacheHit() {
            try {
                showResult('cache-hit-result', '测试缓存命中...', 'info');
                
                const startTime = Date.now();
                const data = await syncManager.loadData();
                const endTime = Date.now();
                
                const message = `✅ 缓存命中测试完成
时间: ${endTime - startTime}ms
数据源: ${data?._metadata?.source || '未知'}
数据大小: ${JSON.stringify(data).length} bytes`;
                
                showResult('cache-hit-result', message, 'success');
                
            } catch (error) {
                showResult('cache-hit-result', `❌ 缓存命中测试失败: ${error.message}`, 'error');
            }
        }

        async function testCacheMiss() {
            try {
                showResult('cache-miss-result', '测试缓存未命中...', 'info');
                
                // 1. 清除Chrome Storage缓存
                await syncManager.clearChromeStorageCache();
                
                // 2. 强制从Supabase加载
                const startTime = Date.now();
                const data = await syncManager.loadData(false, true);
                const endTime = Date.now();
                
                const message = `✅ 缓存未命中测试完成
时间: ${endTime - startTime}ms
数据源: ${data?._metadata?.source || '未知'}
缓存状态: 已重新缓存到Chrome Storage`;
                
                showResult('cache-miss-result', message, 'success');
                
            } catch (error) {
                showResult('cache-miss-result', `❌ 缓存未命中测试失败: ${error.message}`, 'error');
            }
        }

        async function testWriteAndClearCache() {
            try {
                showResult('write-clear-result', '测试写入并清除缓存...', 'info');
                
                const testDataToSave = {
                    ...testData,
                    _testTimestamp: new Date().toISOString()
                };
                
                // 保存数据（应该会清除缓存）
                await syncManager.saveData(testDataToSave);
                
                const message = `✅ 写入清缓存测试完成
数据已保存到Supabase
Chrome Storage缓存已清除
下次读取将从Supabase获取最新数据`;
                
                showResult('write-clear-result', message, 'success');
                
            } catch (error) {
                showResult('write-clear-result', `❌ 写入清缓存测试失败: ${error.message}`, 'error');
            }
        }

        async function testDataConsistency() {
            try {
                showResult('consistency-result', '测试数据一致性...', 'info');
                
                // 1. 从Chrome Storage读取
                const chromeData = await syncManager.loadFromChromeStorage();
                
                // 2. 从Supabase读取
                const supabaseData = await syncManager.loadFromSupabase();
                
                // 3. 比较数据
                const chromeStr = JSON.stringify(chromeData);
                const supabaseStr = JSON.stringify(supabaseData);
                const isConsistent = chromeStr === supabaseStr;
                
                const message = `${isConsistent ? '✅' : '❌'} 数据一致性测试完成
Chrome Storage大小: ${chromeStr.length} bytes
Supabase数据大小: ${supabaseStr.length} bytes
数据一致性: ${isConsistent ? '一致' : '不一致'}`;
                
                showResult('consistency-result', message, isConsistent ? 'success' : 'error');
                
            } catch (error) {
                showResult('consistency-result', `❌ 数据一致性测试失败: ${error.message}`, 'error');
            }
        }

        async function saveTestData() {
            try {
                const testDataStr = document.getElementById('test-data').value.trim();
                if (!testDataStr) {
                    showResult('data-result', '请输入测试数据', 'error');
                    return;
                }

                const data = JSON.parse(testDataStr);
                showResult('data-result', '正在保存数据...', 'info');
                
                await syncManager.saveData(data);
                showResult('data-result', '✅ 数据保存成功！', 'success');
                
            } catch (error) {
                showResult('data-result', `❌ 保存失败: ${error.message}`, 'error');
            }
        }

        async function loadTestData() {
            try {
                showResult('data-result', '正在加载数据...', 'info');
                
                const data = await syncManager.loadData();
                
                if (data) {
                    document.getElementById('test-data').value = JSON.stringify(data, null, 2);
                    showResult('data-result', '✅ 数据加载成功！', 'success');
                } else {
                    showResult('data-result', '📭 没有找到数据', 'info');
                }
                
            } catch (error) {
                showResult('data-result', `❌ 加载失败: ${error.message}`, 'error');
            }
        }

        async function clearAllData() {
            if (!confirm('确定要清除所有数据吗？')) {
                return;
            }

            try {
                showResult('data-result', '正在清除所有数据...', 'info');
                
                // 清除Supabase数据
                await supabaseClient.deleteData();
                
                // 清除Chrome Storage缓存
                await syncManager.clearChromeStorageCache();
                
                showResult('data-result', '✅ 所有数据已清除！', 'success');
                
            } catch (error) {
                showResult('data-result', `❌ 清除失败: ${error.message}`, 'error');
            }
        }

        async function testAddConfig() {
            try {
                showResult('add-config-result', '测试新增配置...', 'info');

                const newConfigName = `测试配置_${Date.now()}`;
                const config = await themeConfigManager.addConfig({
                    displayName: newConfigName,
                    userId: `test_user_${Date.now()}`
                });

                const message = `✅ 新增配置测试完成
配置ID: ${config.id}
配置名称: ${config.displayName}
用户ID: ${config.userId}
缓存状态: 已清除并重新缓存`;

                showResult('add-config-result', message, 'success');

            } catch (error) {
                showResult('add-config-result', `❌ 新增配置测试失败: ${error.message}`, 'error');
            }
        }

        async function testDeleteConfig() {
            try {
                showResult('delete-config-result', '测试删除配置...', 'info');

                // 先获取所有配置
                const configs = themeConfigManager.getAllConfigs();

                if (configs.length === 0) {
                    showResult('delete-config-result', '📭 没有可删除的配置，请先添加配置', 'info');
                    return;
                }

                // 删除第一个配置
                const configToDelete = configs[0];
                await themeConfigManager.deleteConfig(configToDelete.id);

                const message = `✅ 删除配置测试完成
已删除配置: ${configToDelete.displayName}
配置ID: ${configToDelete.id}
缓存状态: 已清除并重新缓存`;

                showResult('delete-config-result', message, 'success');

            } catch (error) {
                showResult('delete-config-result', `❌ 删除配置测试失败: ${error.message}`, 'error');
            }
        }

        async function testConfigListQuery() {
            try {
                showResult('config-list-result', '测试配置列表查询...', 'info');

                // 创建配置UI管理器实例
                const configUI = {
                    currentConfigs: [],
                    async loadConfigListFromSupabase() {
                        console.log('测试：直接从Supabase查询配置列表');

                        const supabaseData = await syncManager.loadFromSupabase();

                        if (supabaseData && supabaseData.themeConfigs && Array.isArray(supabaseData.themeConfigs)) {
                            this.currentConfigs = supabaseData.themeConfigs.filter(config =>
                                config &&
                                config.id &&
                                config.displayName &&
                                config.id !== 'default' &&
                                !config.isDefault
                            );
                        } else {
                            this.currentConfigs = [];
                        }

                        return this.currentConfigs;
                    }
                };

                const startTime = Date.now();
                const configs = await configUI.loadConfigListFromSupabase();
                const endTime = Date.now();

                const message = `✅ 配置列表查询测试完成
查询时间: ${endTime - startTime}ms
数据源: Supabase (直接查询)
配置数量: ${configs.length}
配置列表: ${configs.map(c => c.displayName).join(', ') || '无'}`;

                showResult('config-list-result', message, 'success');

            } catch (error) {
                showResult('config-list-result', `❌ 配置列表查询测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成
        window.addEventListener('load', () => {
            console.log('旁路缓存模式测试工具加载完成');
            updateStatus();
        });
    </script>
</body>
</html>
