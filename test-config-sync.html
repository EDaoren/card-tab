<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #3367d6; }
        .button.success { background: #34a853; }
        .button.danger { background: #ea4335; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ é…ç½®åŒæ­¥æµ‹è¯•</h1>
        <p>æµ‹è¯•é…ç½®ç®¡ç†ç•Œé¢ä¸Supabaseæ•°æ®çš„ä¸€è‡´æ€§</p>

        <div>
            <h3>ğŸ”§ æ“ä½œ</h3>
            <button class="button" onclick="checkSupabaseData()">æ£€æŸ¥Supabaseæ•°æ®</button>
            <button class="button" onclick="checkLocalConfigs()">æ£€æŸ¥æœ¬åœ°é…ç½®</button>
            <button class="button" onclick="forceSync()">å¼ºåˆ¶åŒæ­¥é…ç½®</button>
            <button class="button success" onclick="refreshConfigUI()">åˆ·æ–°é…ç½®ç•Œé¢</button>
            <button class="button danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div>
            <h3>ğŸ“Š Supabaseæ•°æ®</h3>
            <div id="supabase-data" class="data-display">ç‚¹å‡»"æ£€æŸ¥Supabaseæ•°æ®"æŸ¥çœ‹</div>
        </div>

        <div>
            <h3>ğŸ’¾ æœ¬åœ°é…ç½®</h3>
            <div id="local-data" class="data-display">ç‚¹å‡»"æ£€æŸ¥æœ¬åœ°é…ç½®"æŸ¥çœ‹</div>
        </div>

        <div>
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/utils.js"></script>
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme-config-ui.js"></script>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            if (type === 'success') logEntry.style.color = '#155724';
            else if (type === 'error') logEntry.style.color = '#721c24';
            else if (type === 'warning') logEntry.style.color = '#856404';
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // æ£€æŸ¥Supabaseæ•°æ®
        async function checkSupabaseData() {
            try {
                log('ğŸ” æ£€æŸ¥Supabaseæ•°æ®...', 'info');
                
                if (!window.syncManager || !syncManager.isSupabaseEnabled) {
                    log('âŒ Supabaseæœªå¯ç”¨', 'error');
                    document.getElementById('supabase-data').textContent = 'Supabaseæœªå¯ç”¨';
                    return;
                }

                const supabaseData = await syncManager.loadFromSupabase();
                log(`ğŸ“Š Supabaseæ•°æ®è·å–${supabaseData ? 'æˆåŠŸ' : 'å¤±è´¥'}`, supabaseData ? 'success' : 'error');
                
                if (supabaseData) {
                    const displayData = {
                        themeConfigs: supabaseData.themeConfigs || 'æ— ',
                        themeSettings: supabaseData.themeSettings || 'æ— ',
                        categories: supabaseData.categories ? `${supabaseData.categories.length}ä¸ªåˆ†ç±»` : 'æ— ',
                        settings: supabaseData.settings || 'æ— ',
                        _metadata: supabaseData._metadata || 'æ— '
                    };
                    
                    document.getElementById('supabase-data').textContent = JSON.stringify(displayData, null, 2);
                    
                    if (supabaseData.themeConfigs) {
                        log(`ğŸ“‹ Supabaseä¸­æœ‰${supabaseData.themeConfigs.length}ä¸ªé…ç½®`, 'info');
                        supabaseData.themeConfigs.forEach((config, index) => {
                            log(`  ${index + 1}. ${config.displayName} (${config.userId})`, 'info');
                        });
                    } else {
                        log('ğŸ“‹ Supabaseä¸­æ— themeConfigså­—æ®µ', 'warning');
                    }
                } else {
                    document.getElementById('supabase-data').textContent = 'æ— æ•°æ®';
                }
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥Supabaseæ•°æ®å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('supabase-data').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æ£€æŸ¥æœ¬åœ°é…ç½®
        async function checkLocalConfigs() {
            try {
                log('ğŸ” æ£€æŸ¥æœ¬åœ°é…ç½®...', 'info');
                
                if (!window.themeConfigManager) {
                    log('âŒ themeConfigManagerä¸å¯ç”¨', 'error');
                    document.getElementById('local-data').textContent = 'themeConfigManagerä¸å¯ç”¨';
                    return;
                }

                // é‡æ–°åŠ è½½æœ¬åœ°é…ç½®
                await themeConfigManager.loadConfigs();
                
                const allConfigs = themeConfigManager.getAllConfigs();
                const activeConfig = themeConfigManager.getActiveConfig();
                
                log(`ğŸ’¾ æœ¬åœ°é…ç½®æ•°é‡: ${allConfigs.length}`, 'info');
                log(`ğŸ¯ æ´»è·ƒé…ç½®: ${activeConfig ? activeConfig.displayName : 'æ— '}`, 'info');
                
                const displayData = {
                    é…ç½®æ•°é‡: allConfigs.length,
                    æ´»è·ƒé…ç½®: activeConfig ? activeConfig.displayName : 'æ— ',
                    é…ç½®åˆ—è¡¨: allConfigs.map(c => ({
                        id: c.id,
                        displayName: c.displayName,
                        userId: c.userId,
                        isActive: c.isActive
                    }))
                };
                
                document.getElementById('local-data').textContent = JSON.stringify(displayData, null, 2);
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥æœ¬åœ°é…ç½®å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('local-data').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // å¼ºåˆ¶åŒæ­¥é…ç½®
        async function forceSync() {
            try {
                log('ğŸ”„ å¼€å§‹å¼ºåˆ¶åŒæ­¥é…ç½®...', 'info');
                
                if (!window.themeConfigManager) {
                    log('âŒ themeConfigManagerä¸å¯ç”¨', 'error');
                    return;
                }

                // è·å–æœ¬åœ°é…ç½®
                const localConfigs = themeConfigManager.getAllConfigs();
                log(`ğŸ“‹ æœ¬åœ°é…ç½®æ•°é‡: ${localConfigs.length}`, 'info');
                
                if (localConfigs.length === 0) {
                    log('âš ï¸ æœ¬åœ°æ— é…ç½®éœ€è¦åŒæ­¥', 'warning');
                    return;
                }

                // å¼ºåˆ¶ä¿å­˜é…ç½®åˆ°Supabase
                await themeConfigManager.saveConfigs();
                log('âœ… é…ç½®å·²å¼ºåˆ¶åŒæ­¥åˆ°Supabase', 'success');
                
                // éªŒè¯åŒæ­¥ç»“æœ
                setTimeout(async () => {
                    await checkSupabaseData();
                    log('ğŸ” åŒæ­¥åéªŒè¯å®Œæˆ', 'info');
                }, 1000);
                
            } catch (error) {
                log(`âŒ å¼ºåˆ¶åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ·æ–°é…ç½®ç•Œé¢
        async function refreshConfigUI() {
            try {
                log('ğŸ”„ åˆ·æ–°é…ç½®ç•Œé¢...', 'info');
                
                if (!window.themeConfigUIManager) {
                    log('âŒ themeConfigUIManagerä¸å¯ç”¨', 'error');
                    return;
                }

                // å¼ºåˆ¶åˆ·æ–°é…ç½®åˆ—è¡¨
                await themeConfigUIManager.forceRefreshConfigList();
                log('âœ… é…ç½®ç•Œé¢å·²åˆ·æ–°', 'success');
                
            } catch (error) {
                log(`âŒ åˆ·æ–°é…ç½®ç•Œé¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                log('ğŸš€ åˆå§‹åŒ–é…ç½®åŒæ­¥æµ‹è¯•...', 'info');
                
                // ç­‰å¾…å¿…è¦çš„ç®¡ç†å™¨åˆå§‹åŒ–
                if (typeof syncManager !== 'undefined') {
                    await syncManager.init();
                }
                if (typeof themeConfigManager !== 'undefined') {
                    await themeConfigManager.init();
                }
                
                log('âœ… åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // è‡ªåŠ¨æ£€æŸ¥å½“å‰çŠ¶æ€
                await checkLocalConfigs();
                await checkSupabaseData();
                
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
