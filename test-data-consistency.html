<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据一致性测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #3367d6;
        }
        .button.danger {
            background: #ea4335;
        }
        .button.danger:hover {
            background: #d33b2c;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log.success { border-color: #34a853; background: #e8f5e8; }
        .log.error { border-color: #ea4335; background: #fce8e6; }
        .log.warning { border-color: #fbbc04; background: #fef7e0; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 数据一致性测试工具</h1>
        <p>测试主题设置在不同存储系统间的一致性</p>

        <div class="test-section">
            <h3>📊 当前状态</h3>
            <div id="status-display">
                <p>云端同步状态: <span id="sync-status" class="status">未知</span></p>
                <p>当前配置: <span id="current-config">未知</span></p>
                <p>主题设置: <span id="theme-status">未知</span></p>
            </div>
            <button class="button" onclick="checkCurrentStatus()">🔍 检查当前状态</button>
        </div>

        <div class="test-section">
            <h3>🎨 主题设置测试</h3>
            <div>
                <button class="button" onclick="testThemeSave('blue')">保存蓝色主题</button>
                <button class="button" onclick="testThemeSave('green')">保存绿色主题</button>
                <button class="button" onclick="testThemeSave('dark')">保存深色主题</button>
                <button class="button" onclick="testThemeLoad()">重新加载主题</button>
            </div>
            <div id="theme-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>💾 数据存储测试</h3>
            <div>
                <button class="button" onclick="testDataConsistency()">测试数据一致性</button>
                <button class="button" onclick="compareStorageSources()">比较存储源</button>
                <button class="button" onclick="testDataMigration()">测试数据迁移</button>
            </div>
            <div id="storage-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>🔄 同步模式切换测试</h3>
            <div>
                <button class="button" onclick="testSyncToggle()">测试同步开关</button>
                <button class="button" onclick="testConfigSwitch()">测试配置切换</button>
            </div>
            <div id="sync-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>📋 数据查看</h3>
            <div>
                <button class="button" onclick="showAllData()">显示所有数据</button>
                <button class="button" onclick="showChromeStorage()">Chrome Storage</button>
                <button class="button" onclick="showSupabaseData()">Supabase数据</button>
                <button class="button danger" onclick="clearAllData()">清空所有数据</button>
            </div>
            <div id="data-display" class="data-display"></div>
        </div>

        <div class="test-section">
            <h3>📝 测试日志</h3>
            <div id="main-log" class="log"></div>
            <button class="button" onclick="clearLogs()">清空日志</button>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="js/utils.js"></script>
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>

    <script>
        // 日志函数
        function log(message, type = 'info', targetId = 'main-log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(targetId);
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            if (type === 'success') logEntry.style.color = '#155724';
            else if (type === 'error') logEntry.style.color = '#721c24';
            else if (type === 'warning') logEntry.style.color = '#856404';
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('main-log').innerHTML = '';
            document.getElementById('theme-test-log').innerHTML = '';
            document.getElementById('storage-test-log').innerHTML = '';
            document.getElementById('sync-test-log').innerHTML = '';
        }

        // 初始化
        async function init() {
            try {
                log('🚀 初始化数据一致性测试工具...', 'info');
                
                // 初始化存储管理器
                await storageManager.init();
                log('✅ StorageManager 初始化完成', 'success');
                
                // 初始化主题设置
                if (typeof initThemeSettings === 'function') {
                    await initThemeSettings();
                    log('✅ 主题设置初始化完成', 'success');
                }
                
                // 检查当前状态
                await checkCurrentStatus();
                
                log('🎉 测试工具初始化完成', 'success');
            } catch (error) {
                log(`❌ 初始化失败: ${error.message}`, 'error');
            }
        }

        // 检查当前状态
        async function checkCurrentStatus() {
            try {
                log('🔍 检查当前状态...', 'info');
                
                // 检查同步状态
                const syncEnabled = window.syncManager && syncManager.isSupabaseEnabled;
                document.getElementById('sync-status').textContent = syncEnabled ? '已启用' : '已禁用';
                document.getElementById('sync-status').className = `status ${syncEnabled ? 'success' : 'warning'}`;
                
                // 检查当前配置
                let currentConfig = '本地默认';
                if (window.themeConfigManager) {
                    const activeConfig = themeConfigManager.getActiveConfig();
                    if (activeConfig) {
                        currentConfig = activeConfig.displayName;
                    }
                }
                document.getElementById('current-config').textContent = currentConfig;
                
                // 检查主题设置
                const themeInfo = `${window.currentTheme || '未知'} (透明度: ${window.currentBgOpacity || 30}%)`;
                document.getElementById('theme-status').textContent = themeInfo;
                
                log(`✅ 状态检查完成 - 同步: ${syncEnabled ? '启用' : '禁用'}, 配置: ${currentConfig}, 主题: ${themeInfo}`, 'success');
            } catch (error) {
                log(`❌ 状态检查失败: ${error.message}`, 'error');
            }
        }

        // 主题设置测试
        async function testThemeSave(theme) {
            try {
                log(`🎨 测试保存主题: ${theme}`, 'info', 'theme-test-log');

                if (typeof applyThemeForTesting === 'function') {
                    await applyThemeForTesting(theme, true);
                    log(`✅ 主题 ${theme} 保存成功`, 'success', 'theme-test-log');

                    // 验证保存结果
                    await new Promise(resolve => setTimeout(resolve, 500)); // 等待保存完成
                    await testThemeLoad();
                } else if (typeof applyTheme === 'function') {
                    // 备选方案：使用普通的applyTheme函数
                    await applyTheme(theme, true);
                    log(`✅ 主题 ${theme} 保存成功（使用备选方案）`, 'success', 'theme-test-log');
                    await testThemeLoad();
                } else {
                    log(`❌ 主题应用函数不可用`, 'error', 'theme-test-log');
                }
            } catch (error) {
                log(`❌ 保存主题失败: ${error.message}`, 'error', 'theme-test-log');
            }
        }

        async function testThemeLoad() {
            try {
                log(`🔄 测试加载主题设置`, 'info', 'theme-test-log');

                if (typeof loadThemeSettingsForTesting === 'function') {
                    await loadThemeSettingsForTesting();
                    const currentTheme = window.currentTheme;
                    const currentOpacity = window.currentBgOpacity;
                    log(`✅ 主题加载成功: ${currentTheme}, 透明度: ${currentOpacity}%`, 'success', 'theme-test-log');

                    // 更新状态显示
                    await checkCurrentStatus();
                } else if (typeof loadThemeSettings === 'function') {
                    // 备选方案：使用普通的loadThemeSettings函数
                    await loadThemeSettings();
                    const currentTheme = window.currentTheme;
                    const currentOpacity = window.currentBgOpacity;
                    log(`✅ 主题加载成功（使用备选方案）: ${currentTheme}, 透明度: ${currentOpacity}%`, 'success', 'theme-test-log');
                    await checkCurrentStatus();
                } else {
                    log(`❌ 主题加载函数不可用`, 'error', 'theme-test-log');
                }
            } catch (error) {
                log(`❌ 加载主题失败: ${error.message}`, 'error', 'theme-test-log');
            }
        }

        // 数据一致性测试
        async function testDataConsistency() {
            try {
                log(`🔍 测试数据一致性`, 'info', 'storage-test-log');

                // 获取不同来源的数据
                let chromeData = null;
                let supabaseData = null;
                let syncManagerData = null;

                // Chrome Storage数据
                try {
                    if (window.syncManager) {
                        chromeData = await syncManager.loadFromChromeStorage();
                        log(`📱 Chrome Storage数据: ${chromeData ? '有数据' : '无数据'}`, 'info', 'storage-test-log');
                    }
                } catch (error) {
                    log(`⚠️ 无法读取Chrome Storage: ${error.message}`, 'warning', 'storage-test-log');
                }

                // Supabase数据
                try {
                    if (window.syncManager && syncManager.isSupabaseEnabled) {
                        supabaseData = await syncManager.loadFromSupabase();
                        log(`☁️ Supabase数据: ${supabaseData ? '有数据' : '无数据'}`, 'info', 'storage-test-log');
                    }
                } catch (error) {
                    log(`⚠️ 无法读取Supabase: ${error.message}`, 'warning', 'storage-test-log');
                }

                // SyncManager统一数据
                try {
                    if (window.syncManager) {
                        syncManagerData = await syncManager.loadData(false);
                        log(`🔄 SyncManager数据: ${syncManagerData ? '有数据' : '无数据'}`, 'info', 'storage-test-log');
                    }
                } catch (error) {
                    log(`⚠️ 无法读取SyncManager: ${error.message}`, 'warning', 'storage-test-log');
                }

                // 比较主题设置
                const chromeTheme = chromeData?.themeSettings?.theme;
                const supabaseTheme = supabaseData?.themeSettings?.theme;
                const syncManagerTheme = syncManagerData?.themeSettings?.theme;

                log(`🎨 主题对比:`, 'info', 'storage-test-log');
                log(`  Chrome: ${chromeTheme || '无'}`, 'info', 'storage-test-log');
                log(`  Supabase: ${supabaseTheme || '无'}`, 'info', 'storage-test-log');
                log(`  SyncManager: ${syncManagerTheme || '无'}`, 'info', 'storage-test-log');

                // 检查一致性
                const themes = [chromeTheme, supabaseTheme, syncManagerTheme].filter(t => t);
                const isConsistent = themes.length === 0 || themes.every(t => t === themes[0]);

                if (isConsistent) {
                    log(`✅ 主题设置一致`, 'success', 'storage-test-log');
                } else {
                    log(`❌ 主题设置不一致！`, 'error', 'storage-test-log');
                }

            } catch (error) {
                log(`❌ 数据一致性测试失败: ${error.message}`, 'error', 'storage-test-log');
            }
        }

        async function compareStorageSources() {
            try {
                log(`📊 比较存储源数据`, 'info', 'storage-test-log');

                const sources = {};

                // Chrome Storage
                if (window.syncManager) {
                    try {
                        sources.chrome = await syncManager.loadFromChromeStorage();
                    } catch (e) {
                        sources.chrome = null;
                    }
                }

                // Supabase
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    try {
                        sources.supabase = await syncManager.loadFromSupabase();
                    } catch (e) {
                        sources.supabase = null;
                    }
                }

                // 传统存储
                if (window.storage) {
                    try {
                        const legacyData = await storage.get(['quick_nav_theme', 'quick_nav_bg_opacity']);
                        sources.legacy = legacyData;
                    } catch (e) {
                        sources.legacy = null;
                    }
                }

                // 显示比较结果
                document.getElementById('data-display').textContent = JSON.stringify(sources, null, 2);
                log(`📋 存储源数据已显示在数据查看区域`, 'success', 'storage-test-log');

            } catch (error) {
                log(`❌ 比较存储源失败: ${error.message}`, 'error', 'storage-test-log');
            }
        }

        async function testDataMigration() {
            try {
                log(`🔄 测试数据迁移`, 'info', 'storage-test-log');

                // 创建一些传统格式的测试数据
                const testTheme = 'purple';
                const testOpacity = 50;

                log(`📝 创建传统格式测试数据: 主题=${testTheme}, 透明度=${testOpacity}%`, 'info', 'storage-test-log');

                if (window.storage) {
                    await storage.set({
                        'quick_nav_theme': testTheme,
                        'quick_nav_bg_opacity': testOpacity
                    });
                    log(`✅ 传统数据已保存`, 'success', 'storage-test-log');

                    // 重新加载主题设置，触发迁移
                    if (typeof loadThemeSettings === 'function') {
                        await loadThemeSettings();
                        log(`🔄 重新加载主题设置（应该触发迁移）`, 'info', 'storage-test-log');

                        // 检查迁移结果
                        const currentTheme = window.currentTheme;
                        const currentOpacity = window.currentBgOpacity;

                        if (currentTheme === testTheme && currentOpacity === testOpacity) {
                            log(`✅ 数据迁移成功: ${currentTheme}, ${currentOpacity}%`, 'success', 'storage-test-log');
                        } else {
                            log(`❌ 数据迁移失败: 期望 ${testTheme}/${testOpacity}%, 实际 ${currentTheme}/${currentOpacity}%`, 'error', 'storage-test-log');
                        }
                    }
                }
            } catch (error) {
                log(`❌ 数据迁移测试失败: ${error.message}`, 'error', 'storage-test-log');
            }
        }

        // 同步模式切换测试
        async function testSyncToggle() {
            try {
                log(`🔄 测试同步模式切换`, 'info', 'sync-test-log');

                const initialSyncState = window.syncManager && syncManager.isSupabaseEnabled;
                log(`📊 初始同步状态: ${initialSyncState ? '启用' : '禁用'}`, 'info', 'sync-test-log');

                // 保存一个测试主题
                const testTheme = 'pink';
                if (typeof applyThemeForTesting === 'function') {
                    await applyThemeForTesting(testTheme, true);
                    log(`🎨 保存测试主题: ${testTheme}`, 'info', 'sync-test-log');
                } else if (typeof applyTheme === 'function') {
                    await applyTheme(testTheme, true);
                    log(`🎨 保存测试主题: ${testTheme}（备选方案）`, 'info', 'sync-test-log');
                }

                // 模拟同步状态切换（这里只是测试数据读取逻辑）
                log(`🔍 测试不同同步状态下的数据读取`, 'info', 'sync-test-log');

                // 重新加载主题设置
                if (typeof loadThemeSettingsForTesting === 'function') {
                    await loadThemeSettingsForTesting();
                    const loadedTheme = window.currentTheme;
                    log(`📖 重新加载后的主题: ${loadedTheme}`, 'info', 'sync-test-log');

                    if (loadedTheme === testTheme) {
                        log(`✅ 同步状态切换测试通过`, 'success', 'sync-test-log');
                    } else {
                        log(`❌ 同步状态切换测试失败`, 'error', 'sync-test-log');
                    }
                } else if (typeof loadThemeSettings === 'function') {
                    await loadThemeSettings();
                    const loadedTheme = window.currentTheme;
                    log(`📖 重新加载后的主题: ${loadedTheme}（备选方案）`, 'info', 'sync-test-log');

                    if (loadedTheme === testTheme) {
                        log(`✅ 同步状态切换测试通过`, 'success', 'sync-test-log');
                    } else {
                        log(`❌ 同步状态切换测试失败`, 'error', 'sync-test-log');
                    }
                }

            } catch (error) {
                log(`❌ 同步切换测试失败: ${error.message}`, 'error', 'sync-test-log');
            }
        }

        async function testConfigSwitch() {
            try {
                log(`🔄 测试配置切换`, 'info', 'sync-test-log');

                if (window.themeConfigManager) {
                    const configs = themeConfigManager.getAllConfigs();
                    log(`📋 可用配置数量: ${configs.length}`, 'info', 'sync-test-log');

                    for (const config of configs) {
                        log(`  - ${config.displayName} (${config.id})`, 'info', 'sync-test-log');
                    }

                    if (configs.length > 1) {
                        // 切换到第二个配置
                        const targetConfig = configs[1];
                        await themeConfigManager.switchConfig(targetConfig.id);
                        log(`🔄 切换到配置: ${targetConfig.displayName}`, 'info', 'sync-test-log');

                        // 重新加载主题设置
                        if (typeof loadThemeSettingsForTesting === 'function') {
                            await loadThemeSettingsForTesting();
                            log(`📖 配置切换后重新加载主题设置`, 'info', 'sync-test-log');
                        } else if (typeof loadThemeSettings === 'function') {
                            await loadThemeSettings();
                            log(`📖 配置切换后重新加载主题设置（备选方案）`, 'info', 'sync-test-log');
                        }

                        log(`✅ 配置切换测试完成`, 'success', 'sync-test-log');
                    } else {
                        log(`⚠️ 只有一个配置，无法测试切换`, 'warning', 'sync-test-log');
                    }
                } else {
                    log(`❌ themeConfigManager 不可用`, 'error', 'sync-test-log');
                }

            } catch (error) {
                log(`❌ 配置切换测试失败: ${error.message}`, 'error', 'sync-test-log');
            }
        }

        // 数据查看函数
        async function showAllData() {
            try {
                const allData = {};

                // SyncManager数据
                if (window.syncManager) {
                    allData.syncManager = await syncManager.loadData(false);
                }

                // StorageManager数据
                if (window.storageManager) {
                    allData.storageManager = {
                        data: storageManager.data,
                        fullData: storageManager.fullData
                    };
                }

                // 当前主题变量
                allData.currentTheme = {
                    theme: window.currentTheme,
                    bgOpacity: window.currentBgOpacity,
                    bgImageUrl: window.currentBgImageUrl,
                    bgImagePath: window.currentBgImagePath
                };

                document.getElementById('data-display').textContent = JSON.stringify(allData, null, 2);
                log(`📋 所有数据已显示`, 'success');

            } catch (error) {
                log(`❌ 显示数据失败: ${error.message}`, 'error');
            }
        }

        async function showChromeStorage() {
            try {
                const chromeData = {};

                if (window.syncManager) {
                    chromeData.unified = await syncManager.loadFromChromeStorage();
                }

                if (window.storage) {
                    chromeData.legacy = await storage.get(['quick_nav_theme', 'quick_nav_bg_opacity', 'quick_nav_bg_image']);
                }

                document.getElementById('data-display').textContent = JSON.stringify(chromeData, null, 2);
                log(`📱 Chrome Storage数据已显示`, 'success');

            } catch (error) {
                log(`❌ 显示Chrome Storage失败: ${error.message}`, 'error');
            }
        }

        async function showSupabaseData() {
            try {
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    const supabaseData = await syncManager.loadFromSupabase();
                    document.getElementById('data-display').textContent = JSON.stringify(supabaseData, null, 2);
                    log(`☁️ Supabase数据已显示`, 'success');
                } else {
                    document.getElementById('data-display').textContent = 'Supabase未启用或不可用';
                    log(`⚠️ Supabase未启用`, 'warning');
                }
            } catch (error) {
                log(`❌ 显示Supabase数据失败: ${error.message}`, 'error');
            }
        }

        async function clearAllData() {
            if (!confirm('确定要清空所有数据吗？这个操作不可撤销！')) {
                return;
            }

            try {
                log(`🗑️ 开始清空所有数据...`, 'warning');

                // 清空Chrome Storage
                if (chrome && chrome.storage && chrome.storage.sync) {
                    await chrome.storage.sync.clear();
                    log(`✅ Chrome Storage已清空`, 'success');
                }

                // 清空localStorage
                localStorage.clear();
                log(`✅ localStorage已清空`, 'success');

                // 重新初始化
                await init();
                log(`🔄 重新初始化完成`, 'success');

            } catch (error) {
                log(`❌ 清空数据失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
