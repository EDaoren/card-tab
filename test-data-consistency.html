<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¸€è‡´æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #3367d6;
        }
        .button.danger {
            background: #ea4335;
        }
        .button.danger:hover {
            background: #d33b2c;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log.success { border-color: #34a853; background: #e8f5e8; }
        .log.error { border-color: #ea4335; background: #fce8e6; }
        .log.warning { border-color: #fbbc04; background: #fef7e0; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å·¥å…·</h1>
        <p>æµ‹è¯•ä¸»é¢˜è®¾ç½®åœ¨ä¸åŒå­˜å‚¨ç³»ç»Ÿé—´çš„ä¸€è‡´æ€§</p>

        <div class="test-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div id="status-display">
                <p>äº‘ç«¯åŒæ­¥çŠ¶æ€: <span id="sync-status" class="status">æœªçŸ¥</span></p>
                <p>å½“å‰é…ç½®: <span id="current-config">æœªçŸ¥</span></p>
                <p>ä¸»é¢˜è®¾ç½®: <span id="theme-status">æœªçŸ¥</span></p>
            </div>
            <button class="button" onclick="checkCurrentStatus()">ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>ğŸ¨ ä¸»é¢˜è®¾ç½®æµ‹è¯•</h3>
            <div>
                <button class="button" onclick="testThemeSave('blue')">ä¿å­˜è“è‰²ä¸»é¢˜</button>
                <button class="button" onclick="testThemeSave('green')">ä¿å­˜ç»¿è‰²ä¸»é¢˜</button>
                <button class="button" onclick="testThemeSave('dark')">ä¿å­˜æ·±è‰²ä¸»é¢˜</button>
                <button class="button" onclick="testThemeLoad()">é‡æ–°åŠ è½½ä¸»é¢˜</button>
            </div>
            <div id="theme-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ’¾ æ•°æ®å­˜å‚¨æµ‹è¯•</h3>
            <div>
                <button class="button" onclick="testDataConsistency()">æµ‹è¯•æ•°æ®ä¸€è‡´æ€§</button>
                <button class="button" onclick="compareStorageSources()">æ¯”è¾ƒå­˜å‚¨æº</button>
                <button class="button" onclick="testDataMigration()">æµ‹è¯•æ•°æ®è¿ç§»</button>
            </div>
            <div id="storage-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ åŒæ­¥æ¨¡å¼åˆ‡æ¢æµ‹è¯•</h3>
            <div>
                <button class="button" onclick="testSyncToggle()">æµ‹è¯•åŒæ­¥å¼€å…³</button>
                <button class="button" onclick="testConfigSwitch()">æµ‹è¯•é…ç½®åˆ‡æ¢</button>
            </div>
            <div id="sync-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ•°æ®æŸ¥çœ‹</h3>
            <div>
                <button class="button" onclick="showAllData()">æ˜¾ç¤ºæ‰€æœ‰æ•°æ®</button>
                <button class="button" onclick="showChromeStorage()">Chrome Storage</button>
                <button class="button" onclick="showSupabaseData()">Supabaseæ•°æ®</button>
                <button class="button danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            </div>
            <div id="data-display" class="data-display"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div id="main-log" class="log"></div>
            <button class="button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/utils.js"></script>
    <script src="js/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info', targetId = 'main-log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(targetId);
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            if (type === 'success') logEntry.style.color = '#155724';
            else if (type === 'error') logEntry.style.color = '#721c24';
            else if (type === 'warning') logEntry.style.color = '#856404';
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('main-log').innerHTML = '';
            document.getElementById('theme-test-log').innerHTML = '';
            document.getElementById('storage-test-log').innerHTML = '';
            document.getElementById('sync-test-log').innerHTML = '';
        }

        // åˆå§‹åŒ–
        async function init() {
            try {
                log('ğŸš€ åˆå§‹åŒ–æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å·¥å…·...', 'info');
                
                // åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨
                await storageManager.init();
                log('âœ… StorageManager åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // åˆå§‹åŒ–ä¸»é¢˜è®¾ç½®
                if (typeof initThemeSettings === 'function') {
                    await initThemeSettings();
                    log('âœ… ä¸»é¢˜è®¾ç½®åˆå§‹åŒ–å®Œæˆ', 'success');
                }
                
                // æ£€æŸ¥å½“å‰çŠ¶æ€
                await checkCurrentStatus();
                
                log('ğŸ‰ æµ‹è¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥å½“å‰çŠ¶æ€
        async function checkCurrentStatus() {
            try {
                log('ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€...', 'info');
                
                // æ£€æŸ¥åŒæ­¥çŠ¶æ€
                const syncEnabled = window.syncManager && syncManager.isSupabaseEnabled;
                document.getElementById('sync-status').textContent = syncEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                document.getElementById('sync-status').className = `status ${syncEnabled ? 'success' : 'warning'}`;
                
                // æ£€æŸ¥å½“å‰é…ç½®
                let currentConfig = 'æœ¬åœ°é»˜è®¤';
                if (window.themeConfigManager) {
                    const activeConfig = themeConfigManager.getActiveConfig();
                    if (activeConfig) {
                        currentConfig = activeConfig.displayName;
                    }
                }
                document.getElementById('current-config').textContent = currentConfig;
                
                // æ£€æŸ¥ä¸»é¢˜è®¾ç½®
                const themeInfo = `${window.currentTheme || 'æœªçŸ¥'} (é€æ˜åº¦: ${window.currentBgOpacity || 30}%)`;
                document.getElementById('theme-status').textContent = themeInfo;
                
                log(`âœ… çŠ¶æ€æ£€æŸ¥å®Œæˆ - åŒæ­¥: ${syncEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}, é…ç½®: ${currentConfig}, ä¸»é¢˜: ${themeInfo}`, 'success');
            } catch (error) {
                log(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¸»é¢˜è®¾ç½®æµ‹è¯•
        async function testThemeSave(theme) {
            try {
                log(`ğŸ¨ æµ‹è¯•ä¿å­˜ä¸»é¢˜: ${theme}`, 'info', 'theme-test-log');

                if (typeof applyThemeForTesting === 'function') {
                    await applyThemeForTesting(theme, true);
                    log(`âœ… ä¸»é¢˜ ${theme} ä¿å­˜æˆåŠŸ`, 'success', 'theme-test-log');

                    // éªŒè¯ä¿å­˜ç»“æœ
                    await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…ä¿å­˜å®Œæˆ
                    await testThemeLoad();
                } else if (typeof applyTheme === 'function') {
                    // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šçš„applyThemeå‡½æ•°
                    await applyTheme(theme, true);
                    log(`âœ… ä¸»é¢˜ ${theme} ä¿å­˜æˆåŠŸï¼ˆä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆï¼‰`, 'success', 'theme-test-log');
                    await testThemeLoad();
                } else {
                    log(`âŒ ä¸»é¢˜åº”ç”¨å‡½æ•°ä¸å¯ç”¨`, 'error', 'theme-test-log');
                }
            } catch (error) {
                log(`âŒ ä¿å­˜ä¸»é¢˜å¤±è´¥: ${error.message}`, 'error', 'theme-test-log');
            }
        }

        async function testThemeLoad() {
            try {
                log(`ğŸ”„ æµ‹è¯•åŠ è½½ä¸»é¢˜è®¾ç½®`, 'info', 'theme-test-log');

                if (typeof loadThemeSettingsForTesting === 'function') {
                    await loadThemeSettingsForTesting();
                    const currentTheme = window.currentTheme;
                    const currentOpacity = window.currentBgOpacity;
                    log(`âœ… ä¸»é¢˜åŠ è½½æˆåŠŸ: ${currentTheme}, é€æ˜åº¦: ${currentOpacity}%`, 'success', 'theme-test-log');

                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    await checkCurrentStatus();
                } else if (typeof loadThemeSettings === 'function') {
                    // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šçš„loadThemeSettingså‡½æ•°
                    await loadThemeSettings();
                    const currentTheme = window.currentTheme;
                    const currentOpacity = window.currentBgOpacity;
                    log(`âœ… ä¸»é¢˜åŠ è½½æˆåŠŸï¼ˆä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆï¼‰: ${currentTheme}, é€æ˜åº¦: ${currentOpacity}%`, 'success', 'theme-test-log');
                    await checkCurrentStatus();
                } else {
                    log(`âŒ ä¸»é¢˜åŠ è½½å‡½æ•°ä¸å¯ç”¨`, 'error', 'theme-test-log');
                }
            } catch (error) {
                log(`âŒ åŠ è½½ä¸»é¢˜å¤±è´¥: ${error.message}`, 'error', 'theme-test-log');
            }
        }

        // æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
        async function testDataConsistency() {
            try {
                log(`ğŸ” æµ‹è¯•æ•°æ®ä¸€è‡´æ€§`, 'info', 'storage-test-log');

                // è·å–ä¸åŒæ¥æºçš„æ•°æ®
                let chromeData = null;
                let supabaseData = null;
                let syncManagerData = null;

                // Chrome Storageæ•°æ®
                try {
                    if (window.syncManager) {
                        chromeData = await syncManager.loadFromChromeStorage();
                        log(`ğŸ“± Chrome Storageæ•°æ®: ${chromeData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'}`, 'info', 'storage-test-log');
                    }
                } catch (error) {
                    log(`âš ï¸ æ— æ³•è¯»å–Chrome Storage: ${error.message}`, 'warning', 'storage-test-log');
                }

                // Supabaseæ•°æ®
                try {
                    if (window.syncManager && syncManager.isSupabaseEnabled) {
                        supabaseData = await syncManager.loadFromSupabase();
                        log(`â˜ï¸ Supabaseæ•°æ®: ${supabaseData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'}`, 'info', 'storage-test-log');
                    }
                } catch (error) {
                    log(`âš ï¸ æ— æ³•è¯»å–Supabase: ${error.message}`, 'warning', 'storage-test-log');
                }

                // SyncManagerç»Ÿä¸€æ•°æ®
                try {
                    if (window.syncManager) {
                        syncManagerData = await syncManager.loadData(false);
                        log(`ğŸ”„ SyncManageræ•°æ®: ${syncManagerData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'}`, 'info', 'storage-test-log');
                    }
                } catch (error) {
                    log(`âš ï¸ æ— æ³•è¯»å–SyncManager: ${error.message}`, 'warning', 'storage-test-log');
                }

                // æ¯”è¾ƒä¸»é¢˜è®¾ç½®
                const chromeTheme = chromeData?.themeSettings?.theme;
                const supabaseTheme = supabaseData?.themeSettings?.theme;
                const syncManagerTheme = syncManagerData?.themeSettings?.theme;

                log(`ğŸ¨ ä¸»é¢˜å¯¹æ¯”:`, 'info', 'storage-test-log');
                log(`  Chrome: ${chromeTheme || 'æ— '}`, 'info', 'storage-test-log');
                log(`  Supabase: ${supabaseTheme || 'æ— '}`, 'info', 'storage-test-log');
                log(`  SyncManager: ${syncManagerTheme || 'æ— '}`, 'info', 'storage-test-log');

                // æ£€æŸ¥ä¸€è‡´æ€§
                const themes = [chromeTheme, supabaseTheme, syncManagerTheme].filter(t => t);
                const isConsistent = themes.length === 0 || themes.every(t => t === themes[0]);

                if (isConsistent) {
                    log(`âœ… ä¸»é¢˜è®¾ç½®ä¸€è‡´`, 'success', 'storage-test-log');
                } else {
                    log(`âŒ ä¸»é¢˜è®¾ç½®ä¸ä¸€è‡´ï¼`, 'error', 'storage-test-log');
                }

            } catch (error) {
                log(`âŒ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error', 'storage-test-log');
            }
        }

        async function compareStorageSources() {
            try {
                log(`ğŸ“Š æ¯”è¾ƒå­˜å‚¨æºæ•°æ®`, 'info', 'storage-test-log');

                const sources = {};

                // Chrome Storage
                if (window.syncManager) {
                    try {
                        sources.chrome = await syncManager.loadFromChromeStorage();
                    } catch (e) {
                        sources.chrome = null;
                    }
                }

                // Supabase
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    try {
                        sources.supabase = await syncManager.loadFromSupabase();
                    } catch (e) {
                        sources.supabase = null;
                    }
                }

                // ä¼ ç»Ÿå­˜å‚¨
                if (window.storage) {
                    try {
                        const legacyData = await storage.get(['quick_nav_theme', 'quick_nav_bg_opacity']);
                        sources.legacy = legacyData;
                    } catch (e) {
                        sources.legacy = null;
                    }
                }

                // æ˜¾ç¤ºæ¯”è¾ƒç»“æœ
                document.getElementById('data-display').textContent = JSON.stringify(sources, null, 2);
                log(`ğŸ“‹ å­˜å‚¨æºæ•°æ®å·²æ˜¾ç¤ºåœ¨æ•°æ®æŸ¥çœ‹åŒºåŸŸ`, 'success', 'storage-test-log');

            } catch (error) {
                log(`âŒ æ¯”è¾ƒå­˜å‚¨æºå¤±è´¥: ${error.message}`, 'error', 'storage-test-log');
            }
        }

        async function testDataMigration() {
            try {
                log(`ğŸ”„ æµ‹è¯•æ•°æ®è¿ç§»`, 'info', 'storage-test-log');

                // åˆ›å»ºä¸€äº›ä¼ ç»Ÿæ ¼å¼çš„æµ‹è¯•æ•°æ®
                const testTheme = 'purple';
                const testOpacity = 50;

                log(`ğŸ“ åˆ›å»ºä¼ ç»Ÿæ ¼å¼æµ‹è¯•æ•°æ®: ä¸»é¢˜=${testTheme}, é€æ˜åº¦=${testOpacity}%`, 'info', 'storage-test-log');

                if (window.storage) {
                    await storage.set({
                        'quick_nav_theme': testTheme,
                        'quick_nav_bg_opacity': testOpacity
                    });
                    log(`âœ… ä¼ ç»Ÿæ•°æ®å·²ä¿å­˜`, 'success', 'storage-test-log');

                    // é‡æ–°åŠ è½½ä¸»é¢˜è®¾ç½®ï¼Œè§¦å‘è¿ç§»
                    if (typeof loadThemeSettings === 'function') {
                        await loadThemeSettings();
                        log(`ğŸ”„ é‡æ–°åŠ è½½ä¸»é¢˜è®¾ç½®ï¼ˆåº”è¯¥è§¦å‘è¿ç§»ï¼‰`, 'info', 'storage-test-log');

                        // æ£€æŸ¥è¿ç§»ç»“æœ
                        const currentTheme = window.currentTheme;
                        const currentOpacity = window.currentBgOpacity;

                        if (currentTheme === testTheme && currentOpacity === testOpacity) {
                            log(`âœ… æ•°æ®è¿ç§»æˆåŠŸ: ${currentTheme}, ${currentOpacity}%`, 'success', 'storage-test-log');
                        } else {
                            log(`âŒ æ•°æ®è¿ç§»å¤±è´¥: æœŸæœ› ${testTheme}/${testOpacity}%, å®é™… ${currentTheme}/${currentOpacity}%`, 'error', 'storage-test-log');
                        }
                    }
                }
            } catch (error) {
                log(`âŒ æ•°æ®è¿ç§»æµ‹è¯•å¤±è´¥: ${error.message}`, 'error', 'storage-test-log');
            }
        }

        // åŒæ­¥æ¨¡å¼åˆ‡æ¢æµ‹è¯•
        async function testSyncToggle() {
            try {
                log(`ğŸ”„ æµ‹è¯•åŒæ­¥æ¨¡å¼åˆ‡æ¢`, 'info', 'sync-test-log');

                const initialSyncState = window.syncManager && syncManager.isSupabaseEnabled;
                log(`ğŸ“Š åˆå§‹åŒæ­¥çŠ¶æ€: ${initialSyncState ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'info', 'sync-test-log');

                // ä¿å­˜ä¸€ä¸ªæµ‹è¯•ä¸»é¢˜
                const testTheme = 'pink';
                if (typeof applyThemeForTesting === 'function') {
                    await applyThemeForTesting(testTheme, true);
                    log(`ğŸ¨ ä¿å­˜æµ‹è¯•ä¸»é¢˜: ${testTheme}`, 'info', 'sync-test-log');
                } else if (typeof applyTheme === 'function') {
                    await applyTheme(testTheme, true);
                    log(`ğŸ¨ ä¿å­˜æµ‹è¯•ä¸»é¢˜: ${testTheme}ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰`, 'info', 'sync-test-log');
                }

                // æ¨¡æ‹ŸåŒæ­¥çŠ¶æ€åˆ‡æ¢ï¼ˆè¿™é‡Œåªæ˜¯æµ‹è¯•æ•°æ®è¯»å–é€»è¾‘ï¼‰
                log(`ğŸ” æµ‹è¯•ä¸åŒåŒæ­¥çŠ¶æ€ä¸‹çš„æ•°æ®è¯»å–`, 'info', 'sync-test-log');

                // é‡æ–°åŠ è½½ä¸»é¢˜è®¾ç½®
                if (typeof loadThemeSettingsForTesting === 'function') {
                    await loadThemeSettingsForTesting();
                    const loadedTheme = window.currentTheme;
                    log(`ğŸ“– é‡æ–°åŠ è½½åçš„ä¸»é¢˜: ${loadedTheme}`, 'info', 'sync-test-log');

                    if (loadedTheme === testTheme) {
                        log(`âœ… åŒæ­¥çŠ¶æ€åˆ‡æ¢æµ‹è¯•é€šè¿‡`, 'success', 'sync-test-log');
                    } else {
                        log(`âŒ åŒæ­¥çŠ¶æ€åˆ‡æ¢æµ‹è¯•å¤±è´¥`, 'error', 'sync-test-log');
                    }
                } else if (typeof loadThemeSettings === 'function') {
                    await loadThemeSettings();
                    const loadedTheme = window.currentTheme;
                    log(`ğŸ“– é‡æ–°åŠ è½½åçš„ä¸»é¢˜: ${loadedTheme}ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰`, 'info', 'sync-test-log');

                    if (loadedTheme === testTheme) {
                        log(`âœ… åŒæ­¥çŠ¶æ€åˆ‡æ¢æµ‹è¯•é€šè¿‡`, 'success', 'sync-test-log');
                    } else {
                        log(`âŒ åŒæ­¥çŠ¶æ€åˆ‡æ¢æµ‹è¯•å¤±è´¥`, 'error', 'sync-test-log');
                    }
                }

            } catch (error) {
                log(`âŒ åŒæ­¥åˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error', 'sync-test-log');
            }
        }

        async function testConfigSwitch() {
            try {
                log(`ğŸ”„ æµ‹è¯•é…ç½®åˆ‡æ¢`, 'info', 'sync-test-log');

                if (window.themeConfigManager) {
                    const configs = themeConfigManager.getAllConfigs();
                    log(`ğŸ“‹ å¯ç”¨é…ç½®æ•°é‡: ${configs.length}`, 'info', 'sync-test-log');

                    for (const config of configs) {
                        log(`  - ${config.displayName} (${config.id})`, 'info', 'sync-test-log');
                    }

                    if (configs.length > 1) {
                        // åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªé…ç½®
                        const targetConfig = configs[1];
                        await themeConfigManager.switchConfig(targetConfig.id);
                        log(`ğŸ”„ åˆ‡æ¢åˆ°é…ç½®: ${targetConfig.displayName}`, 'info', 'sync-test-log');

                        // é‡æ–°åŠ è½½ä¸»é¢˜è®¾ç½®
                        if (typeof loadThemeSettingsForTesting === 'function') {
                            await loadThemeSettingsForTesting();
                            log(`ğŸ“– é…ç½®åˆ‡æ¢åé‡æ–°åŠ è½½ä¸»é¢˜è®¾ç½®`, 'info', 'sync-test-log');
                        } else if (typeof loadThemeSettings === 'function') {
                            await loadThemeSettings();
                            log(`ğŸ“– é…ç½®åˆ‡æ¢åé‡æ–°åŠ è½½ä¸»é¢˜è®¾ç½®ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰`, 'info', 'sync-test-log');
                        }

                        log(`âœ… é…ç½®åˆ‡æ¢æµ‹è¯•å®Œæˆ`, 'success', 'sync-test-log');
                    } else {
                        log(`âš ï¸ åªæœ‰ä¸€ä¸ªé…ç½®ï¼Œæ— æ³•æµ‹è¯•åˆ‡æ¢`, 'warning', 'sync-test-log');
                    }
                } else {
                    log(`âŒ themeConfigManager ä¸å¯ç”¨`, 'error', 'sync-test-log');
                }

            } catch (error) {
                log(`âŒ é…ç½®åˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error', 'sync-test-log');
            }
        }

        // æ•°æ®æŸ¥çœ‹å‡½æ•°
        async function showAllData() {
            try {
                const allData = {};

                // SyncManageræ•°æ®
                if (window.syncManager) {
                    allData.syncManager = await syncManager.loadData(false);
                }

                // StorageManageræ•°æ®
                if (window.storageManager) {
                    allData.storageManager = {
                        data: storageManager.data,
                        fullData: storageManager.fullData
                    };
                }

                // å½“å‰ä¸»é¢˜å˜é‡
                allData.currentTheme = {
                    theme: window.currentTheme,
                    bgOpacity: window.currentBgOpacity,
                    bgImageUrl: window.currentBgImageUrl,
                    bgImagePath: window.currentBgImagePath
                };

                document.getElementById('data-display').textContent = JSON.stringify(allData, null, 2);
                log(`ğŸ“‹ æ‰€æœ‰æ•°æ®å·²æ˜¾ç¤º`, 'success');

            } catch (error) {
                log(`âŒ æ˜¾ç¤ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function showChromeStorage() {
            try {
                const chromeData = {};

                if (window.syncManager) {
                    chromeData.unified = await syncManager.loadFromChromeStorage();
                }

                if (window.storage) {
                    chromeData.legacy = await storage.get(['quick_nav_theme', 'quick_nav_bg_opacity', 'quick_nav_bg_image']);
                }

                document.getElementById('data-display').textContent = JSON.stringify(chromeData, null, 2);
                log(`ğŸ“± Chrome Storageæ•°æ®å·²æ˜¾ç¤º`, 'success');

            } catch (error) {
                log(`âŒ æ˜¾ç¤ºChrome Storageå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function showSupabaseData() {
            try {
                if (window.syncManager && syncManager.isSupabaseEnabled) {
                    const supabaseData = await syncManager.loadFromSupabase();
                    document.getElementById('data-display').textContent = JSON.stringify(supabaseData, null, 2);
                    log(`â˜ï¸ Supabaseæ•°æ®å·²æ˜¾ç¤º`, 'success');
                } else {
                    document.getElementById('data-display').textContent = 'Supabaseæœªå¯ç”¨æˆ–ä¸å¯ç”¨';
                    log(`âš ï¸ Supabaseæœªå¯ç”¨`, 'warning');
                }
            } catch (error) {
                log(`âŒ æ˜¾ç¤ºSupabaseæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            try {
                log(`ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºæ‰€æœ‰æ•°æ®...`, 'warning');

                // æ¸…ç©ºChrome Storage
                if (chrome && chrome.storage && chrome.storage.sync) {
                    await chrome.storage.sync.clear();
                    log(`âœ… Chrome Storageå·²æ¸…ç©º`, 'success');
                }

                // æ¸…ç©ºlocalStorage
                localStorage.clear();
                log(`âœ… localStorageå·²æ¸…ç©º`, 'success');

                // é‡æ–°åˆå§‹åŒ–
                await init();
                log(`ğŸ”„ é‡æ–°åˆå§‹åŒ–å®Œæˆ`, 'success');

            } catch (error) {
                log(`âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
