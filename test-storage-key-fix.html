<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存储键修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            transition: all 0.3s ease;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .theme-preview {
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            border: 2px solid #ddd;
        }
        
        /* 主题样式 */
        .theme-default { background: #f8f9fa; color: #333; }
        .theme-dark { background: #343a40; color: #fff; }
        .theme-blue { background: #007bff; color: #fff; }
        .theme-green { background: #28a745; color: #fff; }
        
        /* 动态主题应用到body */
        body.theme-default { background: #f5f5f5; }
        body.theme-dark { background: #2c3e50; color: #ecf0f1; }
        body.theme-blue { background: #3498db; color: #fff; }
        body.theme-green { background: #27ae60; color: #fff; }
    </style>
</head>
<body class="theme-default">
    <div class="container">
        <h1>存储键修复测试</h1>
        <p>测试修复后的存储键逻辑，验证禁用云端同步后数据加载是否正确</p>

        <div id="theme-preview" class="theme-preview theme-default">
            当前主题: default
        </div>

        <h3>测试步骤</h3>
        <button onclick="step1()">1. 启用云端同步</button>
        <button onclick="step2()">2. 设置绿色主题</button>
        <button onclick="step3()">3. 禁用云端同步</button>
        <button onclick="step4()">4. 检查存储键</button>
        <button onclick="step5()">5. 重新加载数据</button>
        <button onclick="clearLog()">清空日志</button>

        <div class="log" id="log"></div>
    </div>

    <!-- 加载真实的脚本 -->
    <script src="lib/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme-config-manager.js"></script>
    <script src="js/theme.js"></script>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 更新主题预览
        function updateThemePreview(theme) {
            const preview = document.getElementById('theme-preview');
            preview.className = `theme-preview theme-${theme}`;
            preview.textContent = `当前主题: ${theme}`;
            document.body.className = `theme-${theme}`;
        }

        // 检查存储中的所有数据
        async function checkAllStorageData() {
            log('=== 检查所有存储数据 ===', 'info');
            
            const keys = [
                'quickNavData',
                'quickNavData_default',
                'quickNavData_test-user-123'
            ];
            
            for (const key of keys) {
                try {
                    let data = null;
                    if (chrome && chrome.storage && chrome.storage.sync) {
                        data = await new Promise(resolve => {
                            chrome.storage.sync.get([key], result => resolve(result[key]));
                        });
                    } else {
                        const item = localStorage.getItem(key);
                        data = item ? JSON.parse(item) : null;
                    }
                    
                    if (data) {
                        log(`${key}: 有数据`, 'success');
                        if (data.themeSettings) {
                            log(`  主题: ${data.themeSettings.theme}`, 'info');
                        }
                    } else {
                        log(`${key}: 无数据`, 'warning');
                    }
                } catch (error) {
                    log(`检查 ${key} 失败: ${error.message}`, 'error');
                }
            }
        }

        // 步骤1：启用云端同步
        async function step1() {
            log('=== 步骤1: 启用云端同步 ===', 'info');
            
            try {
                await syncManager.init();
                
                // 模拟启用云端同步
                syncManager.isSupabaseEnabled = true;
                syncManager.storageMode = 'hybrid';
                syncManager.currentSupabaseConfig = {
                    userId: 'test-user-123',
                    url: 'https://test.supabase.co',
                    anonKey: 'test-key',
                    enabled: true
                };
                
                log('✅ 云端同步已启用', 'success');
                log(`当前存储键: ${syncManager.getCurrentStorageKey()}`, 'info');
                
            } catch (error) {
                log(`启用云端同步失败: ${error.message}`, 'error');
            }
        }

        // 步骤2：设置绿色主题
        async function step2() {
            log('=== 步骤2: 设置绿色主题 ===', 'info');
            
            try {
                if (typeof applyTheme !== 'function') {
                    log('❌ applyTheme函数不存在', 'error');
                    return;
                }
                
                await applyTheme('green', true);
                updateThemePreview('green');
                log('✅ 绿色主题已设置', 'success');
                
                // 检查当前存储键和数据
                const storageKey = syncManager.getCurrentStorageKey();
                log(`当前存储键: ${storageKey}`, 'info');
                
                await checkAllStorageData();
                
            } catch (error) {
                log(`设置主题失败: ${error.message}`, 'error');
            }
        }

        // 步骤3：禁用云端同步
        async function step3() {
            log('=== 步骤3: 禁用云端同步 ===', 'info');
            
            try {
                log(`禁用前存储键: ${syncManager.getCurrentStorageKey()}`, 'info');
                log(`禁用前isSupabaseEnabled: ${syncManager.isSupabaseEnabled}`, 'info');
                
                // 模拟禁用云端同步的关键步骤
                // 1. 获取云端数据
                const cloudData = {
                    categories: [],
                    settings: { viewMode: 'grid' },
                    themeSettings: {
                        theme: 'green',
                        backgroundImageUrl: null,
                        backgroundImagePath: null,
                        backgroundOpacity: 30
                    }
                };
                
                // 2. 保存到默认配置
                await syncManager.createOrUpdateDefaultConfig(cloudData);
                log('✅ 默认配置已创建', 'success');
                
                // 3. 禁用同步状态
                syncManager.isSupabaseEnabled = false;
                syncManager.storageMode = 'chrome';
                syncManager.currentSupabaseConfig = null;
                
                log(`禁用后存储键: ${syncManager.getCurrentStorageKey()}`, 'info');
                log(`禁用后isSupabaseEnabled: ${syncManager.isSupabaseEnabled}`, 'info');
                
                await checkAllStorageData();
                
            } catch (error) {
                log(`禁用云端同步失败: ${error.message}`, 'error');
            }
        }

        // 步骤4：检查存储键逻辑
        async function step4() {
            log('=== 步骤4: 检查存储键逻辑 ===', 'info');
            
            try {
                // 测试不同状态下的存储键
                const currentKey = syncManager.getCurrentStorageKey();
                log(`当前存储键: ${currentKey}`, 'info');
                
                // 验证存储键是否正确
                if (currentKey === 'quickNavData_default') {
                    log('✅ 存储键正确，指向默认配置', 'success');
                } else {
                    log(`❌ 存储键错误，期望: quickNavData_default, 实际: ${currentKey}`, 'error');
                }
                
                // 检查该键是否有数据
                let data = null;
                if (chrome && chrome.storage && chrome.storage.sync) {
                    data = await new Promise(resolve => {
                        chrome.storage.sync.get([currentKey], result => resolve(result[currentKey]));
                    });
                } else {
                    const item = localStorage.getItem(currentKey);
                    data = item ? JSON.parse(item) : null;
                }
                
                if (data && data.themeSettings) {
                    log(`✅ 找到主题数据: ${data.themeSettings.theme}`, 'success');
                } else {
                    log('❌ 没有找到主题数据', 'error');
                }
                
            } catch (error) {
                log(`检查存储键失败: ${error.message}`, 'error');
            }
        }

        // 步骤5：重新加载数据
        async function step5() {
            log('=== 步骤5: 重新加载数据 ===', 'info');
            
            try {
                // 重新加载数据
                const loadedData = await syncManager.loadData(false);
                log('从syncManager加载的数据:', 'info');
                log(JSON.stringify(loadedData, null, 2), 'info');
                
                if (loadedData && loadedData.themeSettings) {
                    const theme = loadedData.themeSettings.theme;
                    log(`✅ 成功加载主题: ${theme}`, 'success');
                    
                    // 应用主题
                    if (typeof applyTheme === 'function') {
                        await applyTheme(theme, false);
                        updateThemePreview(theme);
                        log(`✅ 主题已应用: ${theme}`, 'success');
                    }
                } else {
                    log('❌ 没有找到主题设置', 'error');
                }
                
                // 测试完整的主题加载流程
                log('测试完整的主题加载流程...', 'info');
                if (typeof loadThemeSettings === 'function') {
                    await loadThemeSettings();
                    log(`✅ loadThemeSettings完成，当前主题: ${window.currentTheme}`, 'success');
                    updateThemePreview(window.currentTheme);
                }
                
            } catch (error) {
                log(`重新加载数据失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成
        window.addEventListener('load', () => {
            log('存储键修复测试页面加载完成', 'info');
            log('这个测试验证禁用云端同步后的存储键逻辑', 'info');
            log('请按顺序执行所有步骤', 'info');
        });
    </script>
</body>
</html>
